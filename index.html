<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Control de Ingresos - Rectorado</title>

<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">

<style>
:root{
  --bg:#020617;
  --card:#020617;
  --border:#1e293b;
  --text:#e5e7eb;
  --muted:#94a3b8;
}

body{
  background: radial-gradient(circle at top,#1e293b,#020617);
  min-height:100vh;
  color:var(--text);
  padding:20px;
}

.main-card{
  background:var(--card);
  border-radius:16px;
  border:1px solid var(--border);
  box-shadow:0 20px 40px rgba(0,0,0,.6);
}

.stat-card{
  border:1px solid var(--border);
  border-radius:12px;
  padding:20px;
  text-align:center;
}

.person-card{
  border:1px solid var(--border);
  border-radius:12px;
  padding:15px;
  margin-bottom:15px;
}

.filter-card{
  border:1px solid var(--border);
  border-radius:12px;
  padding:20px;
  margin-bottom:20px;
  background: rgba(30, 41, 59, 0.5);
}

.form-control,.form-select,.input-group-text{
  background:#020617;
  border:1px solid var(--border);
  color:var(--text);
}

.form-control::placeholder{color:var(--muted);}

.form-select option {
  background:#020617;
  color:var(--text);
}

.status-badge{
  padding:6px 14px;
  border-radius:999px;
  font-size:.8rem;
  font-weight:600;
  background:#064e3b;
  color:#6ee7b7;
}

.status-badge-exit{
  padding:6px 14px;
  border-radius:999px;
  font-size:.8rem;
  font-weight:600;
  background:#7c2d12;
  color:#fdba74;
}

.destination-badge{
  padding:4px 10px;
  border-radius:999px;
  font-size:.75rem;
  font-weight:600;
  background:#1e40af;
  color:#93c5fd;
  display: inline-block;
  margin-top: 5px;
}

.destination-item{
  border:1px solid var(--border);
  border-radius:8px;
  padding:12px;
  margin-bottom:10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: rgba(30, 41, 59, 0.3);
}

.text-muted{color:rgb(117, 116, 116) !important;}

.btn-group-custom {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.time-info {
  font-size: 0.85rem;
  color: var(--muted);
  margin-top: 5px;
  word-break: break-word;
}

#newDestinationInput {
  display: none;
}

.modal-content {
  background: #1e293b;
  border: 1px solid var(--border);
}

.modal-header {
  border-bottom: 1px solid var(--border);
}

.modal-footer {
  border-top: 1px solid var(--border);
}
</style>
</head>

<body>
<div class="container">
<div class="main-card p-4">

<!-- HEADER -->
<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
<h4><i class="fas fa-building text-primary"></i> Control de Ingresos - Rectorado</h4>

<div class="d-flex gap-2 flex-wrap">
<label class="btn btn-secondary mb-0">
<i class="fas fa-folder-open"></i> Cargar Datos
<input type="file" accept=".json" hidden onchange="loadBaseJSON(event)">
</label>

<button class="btn btn-primary" onclick="exportBaseJSON()">
<i class="fas fa-file-code"></i> Exportar Datos
</button>

<button class="btn btn-info" onclick="exportAttendanceReport()">
<i class="fas fa-file-alt"></i> Reporte General
</button>

<button class="btn btn-success" onclick="sendReportByWhatsApp()">
  <i class="fab fa-whatsapp"></i> WhatsApp
</button>

</div>
</div>

<!-- STATS -->
<div class="row mb-4 text-center">
<div class="col-md-4"><div class="stat-card"><h5 id="totalPersons">0</h5><small>Total Visitantes</small></div></div>
<div class="col-md-4"><div class="stat-card"><h5 id="totalInside">0</h5><small>Dentro</small></div></div>
<div class="col-md-4"><div class="stat-card"><h5 id="totalExit">0</h5><small>Salieron</small></div></div>
</div>

<!-- TABS -->
<ul class="nav nav-tabs mb-3">
<li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#control">Registro de Ingresos</button></li>
<li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#register">Nuevo Ingreso</button></li>
<li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#destinations">Gestionar Destinos</button></li>
</ul>

<div class="tab-content">

<!-- CONTROL -->
<div class="tab-pane fade show active" id="control">

<!-- FILTROS -->
<div class="filter-card">
  <div class="row g-3">
    <!-- Filtro de fecha para la tabla -->
    <div class="col-md-4">
      <label class="form-label"><i class="fas fa-calendar"></i> Filtrar Tabla por Fecha</label>
      <input type="date" id="tableFilterDate" class="form-control" onchange="applyTableFilter()">
      <small class="text-muted">Deja vac√≠o para ver todos</small>
    </div>
    
    <!-- B√∫squeda por texto -->
    <div class="col-md-4">
      <label class="form-label"><i class="fas fa-search"></i> Buscar</label>
      <input id="searchInput" class="form-control" placeholder="Buscar por nombre o destino" 
             oninput="applyTableFilter()">
    </div>
    
    <!-- Bot√≥n limpiar filtros -->
    <div class="col-md-4">
      <label class="form-label">&nbsp;</label>
      <button class="btn btn-secondary w-100" onclick="clearTableFilters()">
        <i class="fas fa-times"></i> Limpiar Filtros
      </button>
    </div>
  </div>
  <div id="tableFilterInfo" class="mt-2 text-info small"></div>
</div>

<!-- FILTRO DE FECHA PARA REPORTES -->
<div class="filter-card">
  <h6 class="mb-3"><i class="fas fa-file-download"></i> Generar Reportes</h6>
  <div class="row align-items-end">
    <div class="col-md-4">
      <label class="form-label"><i class="fas fa-calendar"></i> Fecha para Reportes</label>
      <input type="date" id="reportDate" class="form-control" value="">
    </div>
    <div class="col-md-8">
      <div class="btn-group-custom">
        <button class="btn btn-info" onclick="generateDateReport()">
          <i class="fas fa-file-alt"></i> Excel
        </button>
        <button class="btn btn-success" onclick="sendDateReportByWhatsApp()">
          <i class="fab fa-whatsapp"></i> WhatsApp
        </button>
        <button class="btn btn-warning" onclick="generateDatePDF()">
          <i class="fas fa-file-pdf"></i> PDF
        </button>
      </div>
    </div>
  </div>
  <div id="dateFilterInfo" class="mt-2 text-info small"></div>
</div>

<div id="personsList"></div>
</div>

<!-- REGISTER -->
<div class="tab-pane fade" id="register">
<div class="row justify-content-center">
<div class="col-md-6">
<div class="card bg-dark text-light">
<div class="card-body">
<h5 class="mb-3"><i class="fas fa-user-check"></i> Registrar Nuevo Ingreso</h5>
<div class="alert alert-info">
  <i class="fas fa-info-circle"></i> Al registrar, se guarda autom√°ticamente la fecha y hora de ingreso.
</div>
<div class="mb-3">
  <label class="form-label"><i class="fas fa-user"></i> Nombre del Visitante</label>
  <input class="form-control" id="inputName" placeholder="Ej: Juan P√©rez Gonz√°lez">
</div>
<div class="mb-3">
  <label class="form-label"><i class="fas fa-map-marker-alt"></i> Oficina / Unidad / Destino</label>
  <select class="form-select" id="selectDestination" onchange="handleDestinationChange()">
    <option value="">-- Seleccionar destino --</option>
  </select>
</div>
<div class="mb-3" id="newDestinationInput">
  <label class="form-label">Nuevo Destino</label>
  <input class="form-control" id="inputNewDestination" placeholder="Ej: Direcci√≥n Acad√©mica, Decanato, Secretar√≠a General">
</div>
<button class="btn btn-primary w-100 btn-lg" onclick="addPerson()">
  <i class="fas fa-sign-in-alt"></i> Registrar Ingreso
</button>
</div>
</div>
</div>
</div>
</div>

<!-- DESTINATIONS MANAGEMENT -->
<div class="tab-pane fade" id="destinations">
<div class="row justify-content-center">
<div class="col-md-8">
<div class="card bg-dark text-light">
<div class="card-body">
<h5 class="mb-3"><i class="fas fa-building"></i> Gestionar Destinos/Unidades</h5>
<div class="alert alert-info">
  <i class="fas fa-info-circle"></i> Aqu√≠ puedes agregar o eliminar destinos que aparecer√°n en el formulario de registro.
</div>

<!-- Agregar nuevo destino -->
<div class="mb-4">
  <label class="form-label"><i class="fas fa-plus-circle"></i> Agregar Nuevo Destino</label>
  <div class="input-group">
    <input class="form-control" id="newDestinationManual" placeholder="Ej: Vicerrector√≠a Acad√©mica">
    <button class="btn btn-success" onclick="addDestinationManual()">
      <i class="fas fa-plus"></i> Agregar
    </button>
  </div>
</div>

<!-- Lista de destinos -->
<div class="mb-3">
  <h6><i class="fas fa-list"></i> Destinos Registrados (<span id="destinationCount">0</span>)</h6>
  <div id="destinationsList"></div>
</div>

</div>
</div>
</div>
</div>
</div>

</div>
</div>
</div>

<!-- MODAL EDITAR REGISTRO -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-edit"></i> Editar Registro</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editIndex">
        
        <div class="mb-3">
          <label class="form-label"><i class="fas fa-user"></i> Nombre del Visitante</label>
          <input class="form-control" id="editName">
        </div>
        
        <div class="mb-3">
          <label class="form-label"><i class="fas fa-map-marker-alt"></i> Destino</label>
          <select class="form-select" id="editDestination" onchange="handleEditDestinationChange()">
            <option value="">-- Seleccionar destino --</option>
          </select>
        </div>
        
        <div class="mb-3" id="editNewDestinationInput" style="display:none;">
          <label class="form-label">Nuevo Destino</label>
          <input class="form-control" id="editNewDestination">
        </div>
        
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label"><i class="fas fa-sign-in-alt"></i> Fecha de Ingreso</label>
            <input type="date" class="form-control" id="editEntryDate">
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label"><i class="fas fa-clock"></i> Hora de Ingreso</label>
            <input type="time" class="form-control" id="editEntryTime" step="1">
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label"><i class="fas fa-sign-out-alt"></i> Fecha de Salida</label>
            <input type="date" class="form-control" id="editExitDate">
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label"><i class="fas fa-clock"></i> Hora de Salida</label>
            <input type="time" class="form-control" id="editExitTime" step="1">
          </div>
        </div>
        
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="editClearExit">
          <label class="form-check-label" for="editClearExit">
            Borrar hora de salida (marcar como "Dentro")
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times"></i> Cancelar
        </button>
        <button type="button" class="btn btn-primary" onclick="saveEdit()">
          <i class="fas fa-save"></i> Guardar Cambios
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>

// ============================
// Estado inicial
// ============================
let peopleBase = JSON.parse(localStorage.getItem("attendanceBase")) || [];
let destinationsBase = JSON.parse(localStorage.getItem("destinationsBase")) || [];
let currentFilteredList = [];

// ============================
// Al cargar la p√°gina
// ============================
document.addEventListener("DOMContentLoaded", () => {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById("reportDate").value = today;
    
    loadDestinations();
    currentFilteredList = [...peopleBase];
    renderPersons(currentFilteredList);
    renderDestinationsList();
    updateStats();
    updateDateFilterInfo();
});

// ============================
// Aplicar filtros de tabla
// ============================
function applyTableFilter() {
    const dateFilter = document.getElementById("tableFilterDate").value;
    const searchQuery = document.getElementById("searchInput").value.toLowerCase().trim();
    
    let filtered = [...peopleBase];
    
    // Filtrar por fecha
    if (dateFilter) {
        filtered = filterPeopleByDate(dateFilter, filtered);
    }
    
    // Filtrar por b√∫squeda
    if (searchQuery) {
        filtered = filtered.filter(p => 
            p.name.toLowerCase().includes(searchQuery) ||
            (p.destination && p.destination.toLowerCase().includes(searchQuery))
        );
    }
    
    currentFilteredList = filtered;
    renderPersons(currentFilteredList);
    updateTableFilterInfo(dateFilter, filtered.length);
}

// ============================
// Actualizar info de filtro de tabla
// ============================
function updateTableFilterInfo(date, count) {
    const infoDiv = document.getElementById("tableFilterInfo");
    
    if (date) {
        const formattedDate = new Date(date + 'T00:00:00').toLocaleDateString('es-ES');
        if (count > 0) {
            infoDiv.innerHTML = `<i class="fas fa-filter"></i> Mostrando ${count} registro(s) del ${formattedDate}`;
        } else {
            infoDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> No hay registros para el ${formattedDate}`;
        }
    } else {
        if (count < peopleBase.length) {
            infoDiv.innerHTML = `<i class="fas fa-filter"></i> Mostrando ${count} de ${peopleBase.length} registros`;
        } else {
            infoDiv.innerHTML = "";
        }
    }
}

// ============================
// Limpiar filtros de tabla
// ============================
function clearTableFilters() {
    document.getElementById("tableFilterDate").value = "";
    document.getElementById("searchInput").value = "";
    currentFilteredList = [...peopleBase];
    renderPersons(currentFilteredList);
    document.getElementById("tableFilterInfo").innerHTML = "";
}

// ============================
// Cargar destinos en el select
// ============================
function loadDestinations() {
    const select = document.getElementById("selectDestination");
    const editSelect = document.getElementById("editDestination");
    
    [select, editSelect].forEach(sel => {
        sel.innerHTML = '<option value="">-- Seleccionar destino --</option>';
        
        destinationsBase.sort().forEach(dest => {
            const option = document.createElement("option");
            option.value = dest;
            option.textContent = dest;
            sel.appendChild(option);
        });
        
        const optionOther = document.createElement("option");
        optionOther.value = "NUEVO";
        optionOther.textContent = "‚ûï Otro (nuevo destino)";
        sel.appendChild(optionOther);
    });
}

// ============================
// Renderizar lista de destinos
// ============================
function renderDestinationsList() {
    const container = document.getElementById("destinationsList");
    const countSpan = document.getElementById("destinationCount");
    
    container.innerHTML = "";
    countSpan.textContent = destinationsBase.length;
    
    if (destinationsBase.length === 0) {
        container.innerHTML = `<p class="text-muted text-center">No hay destinos registrados. Agrega uno arriba.</p>`;
        return;
    }
    
    const sortedDestinations = [...destinationsBase].sort();
    
    sortedDestinations.forEach((dest) => {
        const item = document.createElement("div");
        item.className = "destination-item";
        item.innerHTML = `
            <div>
                <i class="fas fa-building text-primary"></i>
                <strong>${dest}</strong>
            </div>
            <button class="btn btn-sm btn-danger" onclick="deleteDestination('${dest.replace(/'/g, "\\'")}')">
                <i class="fas fa-trash"></i>
            </button>
        `;
        container.appendChild(item);
    });
}

// ============================
// Agregar destino manual
// ============================
function addDestinationManual() {
    const input = document.getElementById("newDestinationManual");
    const newDest = input.value.trim();
    
    if (!newDest) {
        alert("Por favor, ingrese un nombre de destino.");
        return;
    }
    
    if (destinationsBase.includes(newDest)) {
        alert("Este destino ya existe.");
        return;
    }
    
    destinationsBase.push(newDest);
    saveDestinations();
    loadDestinations();
    renderDestinationsList();
    
    input.value = "";
    alert(`‚úÖ Destino "${newDest}" agregado exitosamente.`);
}

// ============================
// Eliminar destino
// ============================
function deleteDestination(dest) {
    if (confirm(`¬øEst√° seguro de eliminar el destino "${dest}"?`)) {
        destinationsBase = destinationsBase.filter(d => d !== dest);
        saveDestinations();
        loadDestinations();
        renderDestinationsList();
    }
}

// ============================
// Guardar destinos
// ============================
function saveDestinations() {
    localStorage.setItem("destinationsBase", JSON.stringify(destinationsBase));
}

// ============================
// Manejar cambio en select de destino
// ============================
function handleDestinationChange() {
    const select = document.getElementById("selectDestination");
    const newDestinationDiv = document.getElementById("newDestinationInput");
    const newDestinationInput = document.getElementById("inputNewDestination");
    
    if (select.value === "NUEVO") {
        newDestinationDiv.style.display = "block";
        newDestinationInput.value = "";
        newDestinationInput.focus();
    } else {
        newDestinationDiv.style.display = "none";
        newDestinationInput.value = "";
    }
}

// ============================
// Manejar cambio en select de destino (edici√≥n)
// ============================
function handleEditDestinationChange() {
    const select = document.getElementById("editDestination");
    const newDestinationDiv = document.getElementById("editNewDestinationInput");
    const newDestinationInput = document.getElementById("editNewDestination");
    
    if (select.value === "NUEVO") {
        newDestinationDiv.style.display = "block";
        newDestinationInput.value = "";
        newDestinationInput.focus();
    } else {
        newDestinationDiv.style.display = "none";
        newDestinationInput.value = "";
    }
}

// ============================
// Actualizar info del filtro de fecha para reportes
// ============================
function updateDateFilterInfo() {
    const selectedDate = document.getElementById("reportDate").value;
    if (!selectedDate) return;
    
    const filtered = filterPeopleByDate(selectedDate);
    const infoDiv = document.getElementById("dateFilterInfo");
    
    if (filtered.length > 0) {
        const formattedDate = new Date(selectedDate + 'T00:00:00').toLocaleDateString('es-ES');
        infoDiv.innerHTML = `<i class="fas fa-info-circle"></i> ${filtered.length} registro(s) disponibles para reportes del ${formattedDate}`;
    } else {
        const formattedDate = new Date(selectedDate + 'T00:00:00').toLocaleDateString('es-ES');
        infoDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> No hay registros para generar reportes del ${formattedDate}`;
    }
}

// ============================
// Renderizar lista de personas
// ============================
function renderPersons(list) {
    const container = document.getElementById("personsList");
    container.innerHTML = "";

    if (list.length === 0) {
        container.innerHTML = `<p class="text-muted">No hay registros que coincidan con los filtros.</p>`;
        return;
    }

    list.forEach((person) => {
        const originalIndex = peopleBase.indexOf(person);
        const hasExit = person.exitTime ? true : false;
        const statusBadgeClass = hasExit ? "status-badge-exit" : "status-badge";
        const statusText = hasExit ? "Sali√≥" : "Dentro";
        const statusIcon = hasExit ? "fa-sign-out-alt" : "fa-check-circle";
        
        const entryInfo = `<div class="time-info"><i class="fas fa-sign-in-alt text-success"></i> Ingreso: ${formatDateTime(person.entryTime)}</div>`;
        
        let exitInfo = "";
        if (hasExit) {
            exitInfo = `<div class="time-info"><i class="fas fa-sign-out-alt text-warning"></i> Salida: ${formatDateTime(person.exitTime)}</div>`;
        }
        
        const destinationBadge = person.destination ? 
            `<span class="destination-badge"><i class="fas fa-building"></i> ${person.destination}</span>` : '';

        const card = document.createElement("div");
        card.className = "person-card";
        card.innerHTML = `
            <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
                <div style="flex: 1; min-width: 0;">
                    <strong>${originalIndex + 1}. ${person.name}</strong>
                    <br>
                    ${destinationBadge}
                    ${entryInfo}
                    ${exitInfo}
                </div>
                <div class="text-end" style="flex-shrink: 0;">
                    <span class="${statusBadgeClass}"><i class="fas ${statusIcon}"></i> ${statusText}</span><br>
                    <div class="btn-group mt-2" role="group">
                        <button class="btn btn-sm btn-info" onclick="openEditModal(${originalIndex})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${!hasExit ? `<button class="btn btn-sm btn-warning" onclick="markExit(${originalIndex})" title="Marcar Salida">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>` : ''}
                        <button class="btn btn-sm btn-danger" onclick="deletePerson(${originalIndex})" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(card);
    });
}

// Funci√≥n auxiliar para mostrar fechas y horas legibles
function formatDateTime(isoString) {
    if (!isoString) return "-";
    const date = new Date(isoString);
    if (isNaN(date.getTime())) return isoString;
    return date.toLocaleString("es-ES", {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
}

// ============================
// Abrir modal de edici√≥n
// ============================
function openEditModal(index) {
    const person = peopleBase[index];
    
    document.getElementById("editIndex").value = index;
    document.getElementById("editName").value = person.name;
    
    // Cargar destino
    const editDestSelect = document.getElementById("editDestination");
    if (destinationsBase.includes(person.destination)) {
        editDestSelect.value = person.destination;
    } else {
        editDestSelect.value = "NUEVO";
        document.getElementById("editNewDestinationInput").style.display = "block";
        document.getElementById("editNewDestination").value = person.destination;
    }
    
    // Cargar fecha y hora de entrada
    if (person.entryTime) {
        const entryDate = new Date(person.entryTime);
        document.getElementById("editEntryDate").value = entryDate.toISOString().split('T')[0];
        document.getElementById("editEntryTime").value = entryDate.toTimeString().split(' ')[0];
    }
    
    // Cargar fecha y hora de salida
    if (person.exitTime) {
        const exitDate = new Date(person.exitTime);
        document.getElementById("editExitDate").value = exitDate.toISOString().split('T')[0];
        document.getElementById("editExitTime").value = exitDate.toTimeString().split(' ')[0];
    } else {
        document.getElementById("editExitDate").value = "";
        document.getElementById("editExitTime").value = "";
    }
    
    document.getElementById("editClearExit").checked = false;
    
    const modal = new bootstrap.Modal(document.getElementById('editModal'));
    modal.show();
}

// ============================
// Guardar edici√≥n
// ============================
function saveEdit() {
    const index = parseInt(document.getElementById("editIndex").value);
    const name = document.getElementById("editName").value.trim();
    const editDestSelect = document.getElementById("editDestination");
    const editNewDestInput = document.getElementById("editNewDestination");
    const entryDate = document.getElementById("editEntryDate").value;
    const entryTime = document.getElementById("editEntryTime").value;
    const exitDate = document.getElementById("editExitDate").value;
    const exitTime = document.getElementById("editExitTime").value;
    const clearExit = document.getElementById("editClearExit").checked;
    
    if (!name) {
        alert("El nombre no puede estar vac√≠o.");
        return;
    }
    
    // Determinar destino
    let destination = "";
    if (editDestSelect.value === "NUEVO") {
        destination = editNewDestInput.value.trim();
        if (!destination) {
            alert("Por favor, ingrese el destino.");
            return;
        }
        if (!destinationsBase.includes(destination)) {
            destinationsBase.push(destination);
            saveDestinations();
        }
    } else {
        destination = editDestSelect.value;
        if (!destination) {
            alert("Por favor, seleccione un destino.");
            return;
        }
    }
    
    // Crear fecha/hora de entrada
    if (!entryDate || !entryTime) {
        alert("La fecha y hora de ingreso son obligatorias.");
        return;
    }
    const entryDateTime = new Date(`${entryDate}T${entryTime}`).toISOString();
    
    // Crear fecha/hora de salida
    let exitDateTime = null;
    if (!clearExit && exitDate && exitTime) {
        exitDateTime = new Date(`${exitDate}T${exitTime}`).toISOString();
    }
    
    // Actualizar registro
    peopleBase[index].name = name;
    peopleBase[index].destination = destination;
    peopleBase[index].entryTime = entryDateTime;
    peopleBase[index].exitTime = exitDateTime;
    
    saveToLocalStorage();
    loadDestinations();
    renderDestinationsList();
    applyTableFilter();
    updateStats();
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
    modal.hide();
    
    alert("‚úÖ Registro actualizado exitosamente.");
}

// ============================
// Marcar salida
// ============================
function markExit(index) {
    if (confirm(`¬øMarcar la salida de ${peopleBase[index].name}?`)) {
        const now = new Date().toISOString();
        peopleBase[index].exitTime = now;
        saveToLocalStorage();
        applyTableFilter();
        updateStats();
    }
}

// ============================
// Eliminar persona
// ============================
function deletePerson(index) {
    if (confirm(`¬øEst√° seguro de eliminar el registro de ${peopleBase[index].name}?`)) {
        peopleBase.splice(index, 1);
        saveToLocalStorage();
        applyTableFilter();
        updateStats();
        updateDateFilterInfo();
    }
}

// ============================
// Filtrar personas por fecha
// ============================
function filterPeopleByDate(targetDate, list = peopleBase) {
    if (!targetDate) return list;
    
    const targetParts = targetDate.split('-');
    const targetYear = parseInt(targetParts[0]);
    const targetMonth = parseInt(targetParts[1]) - 1;
    const targetDay = parseInt(targetParts[2]);
    
    return list.filter(p => {
        if (p.entryTime) {
            const entryDate = new Date(p.entryTime);
            const entryYear = entryDate.getFullYear();
            const entryMonth = entryDate.getMonth();
            const entryDay = entryDate.getDate();
            
            return entryYear === targetYear && 
                   entryMonth === targetMonth && 
                   entryDay === targetDay;
        }
        return false;
    });
}

// ============================
// Registrar persona
// ============================
function addPerson() {
    const name = document.getElementById("inputName").value.trim();
    const selectDestination = document.getElementById("selectDestination");
    const newDestinationInput = document.getElementById("inputNewDestination");
    
    let destination = "";
    
    if (!name) {
        alert("Por favor, ingrese el nombre del visitante.");
        return;
    }

    if (selectDestination.value === "NUEVO") {
        destination = newDestinationInput.value.trim();
        if (!destination) {
            alert("Por favor, ingrese el destino.");
            return;
        }
        
        if (!destinationsBase.includes(destination)) {
            destinationsBase.push(destination);
            saveDestinations();
        }
    } else {
        destination = selectDestination.value.trim();
        if (!destination) {
            alert("Por favor, seleccione un destino.");
            return;
        }
    }

    const now = new Date().toISOString();

    const newPerson = {
        name,
        destination,
        entryTime: now,
        exitTime: null
    };

    peopleBase.push(newPerson);
    saveToLocalStorage();
    loadDestinations();
    renderDestinationsList();
    applyTableFilter();
    updateStats();
    updateDateFilterInfo();

    document.getElementById("inputName").value = "";
    selectDestination.value = "";
    newDestinationInput.value = "";
    document.getElementById("newDestinationInput").style.display = "none";

    const controlTab = new bootstrap.Tab(document.querySelector('.nav-link[data-bs-target="#control"]'));
    controlTab.show();
    
    alert(`‚úÖ Ingreso registrado exitosamente\n\nVisitante: ${name}\nDestino: ${destination}\nHora: ${formatDateTime(now)}`);
}

// ============================
// Guardar en localStorage
// ============================
function saveToLocalStorage() {
    localStorage.setItem("attendanceBase", JSON.stringify(peopleBase));
}

// ============================
// Actualizar estad√≠sticas
// ============================
function updateStats() {
    const total = peopleBase.length;
    const inside = peopleBase.filter(p => !p.exitTime).length;
    const exit = peopleBase.filter(p => p.exitTime).length;
    
    document.getElementById("totalPersons").textContent = total;
    document.getElementById("totalInside").textContent = inside;
    document.getElementById("totalExit").textContent = exit;
}

// Contin√∫a en el siguiente mensaje...
// ============================
// Generar informe del d√≠a (Excel)
// ============================
async function generateDateReport() {
    const selectedDate = document.getElementById("reportDate").value;
    
    if (!selectedDate) {
        alert("Por favor seleccione una fecha");
        return;
    }
    
    const filteredPeople = filterPeopleByDate(selectedDate);
    
    if (filteredPeople.length === 0) {
        alert("No hay ingresos registrados para la fecha seleccionada");
        return;
    }
    
    const ExcelJS = window.ExcelJS || await import('https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js');
    
    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet('Ingresos');
    
    const formattedDate = new Date(selectedDate + 'T00:00:00').toLocaleDateString('es-ES');
    
    worksheet.mergeCells('A1:E1');
    const titleCell = worksheet.getCell('A1');
    titleCell.value = `REGISTRO DE INGRESOS AL RECTORADO - ${formattedDate}`;
    titleCell.font = { bold: true, size: 14 };
    titleCell.alignment = { horizontal: 'center', vertical: 'middle' };
    titleCell.fill = {
        type: 'pattern',
        pattern: 'solid',
        fgColor: { argb: 'FFFFFF00' }
    };
    titleCell.border = {
        top: { style: 'thin' },
        left: { style: 'thin' },
        bottom: { style: 'thin' },
        right: { style: 'thin' }
    };
    
    ['B1', 'C1', 'D1', 'E1'].forEach(cell => {
        const c = worksheet.getCell(cell);
        c.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FFFFFF00' }
        };
        c.border = {
            top: { style: 'thin' },
            left: { style: 'thin' },
            bottom: { style: 'thin' },
            right: { style: 'thin' }
        };
    });
    
    const headers = ['#', 'Nombre del Visitante', 'Oficina/Unidad', 'Hora de Ingreso', 'Hora de Salida'];
    worksheet.getRow(2).values = headers;
    
    headers.forEach((header, index) => {
        const cell = worksheet.getCell(2, index + 1);
        cell.font = { bold: true };
        cell.alignment = { horizontal: 'center', vertical: 'middle' };
        cell.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FFFFFF00' }
        };
        cell.border = {
            top: { style: 'thin' },
            left: { style: 'thin' },
            bottom: { style: 'thin' },
            right: { style: 'thin' }
        };
    });
    
    let row = 3;
    filteredPeople.forEach((p, idx) => {
        const entryTime = p.entryTime ? new Date(p.entryTime).toLocaleString("es-ES", {
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit"
        }) : "-";
        
        const exitTime = p.exitTime ? new Date(p.exitTime).toLocaleString("es-ES", {
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit"
        }) : "-";
        
        worksheet.getRow(row).values = [idx + 1, p.name, p.destination || "-", entryTime, exitTime];
        
        [1, 2, 3, 4, 5].forEach(col => {
            const cell = worksheet.getCell(row, col);
            cell.border = {
                top: { style: 'thin' },
                left: { style: 'thin' },
                bottom: { style: 'thin' },
                right: { style: 'thin' }
            };
        });
        
        row++;
    });
    
    const summaryRow = row + 1;
    const inside = filteredPeople.filter(p => !p.exitTime).length;
    const exit = filteredPeople.filter(p => p.exitTime).length;
    
    worksheet.getRow(summaryRow).values = [
        '',
        `TOTAL: ${filteredPeople.length}`,
        `Dentro: ${inside}`,
        `Salieron: ${exit}`,
        ''
    ];
    
    [1, 2, 3, 4, 5].forEach(col => {
        const cell = worksheet.getCell(summaryRow, col);
        cell.font = { bold: true };
        cell.alignment = { horizontal: 'center', vertical: 'middle' };
        cell.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FFFFFF00' }
        };
        cell.border = {
            top: { style: 'thin' },
            left: { style: 'thin' },
            bottom: { style: 'thin' },
            right: { style: 'thin' }
        };
    });
    
    worksheet.getColumn(1).width = 8;
    worksheet.getColumn(2).width = 35;
    worksheet.getColumn(3).width = 30;
    worksheet.getColumn(4).width = 20;
    worksheet.getColumn(5).width = 20;
    
    const buffer = await workbook.xlsx.writeBuffer();
    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Ingresos_Rectorado_${selectedDate}.xlsx`;
    a.click();
    window.URL.revokeObjectURL(url);
}

// ============================
// Enviar reporte del d√≠a por WhatsApp
// ============================
function sendDateReportByWhatsApp() {
    const selectedDate = document.getElementById("reportDate").value;
    
    if (!selectedDate) {
        alert("Por favor seleccione una fecha");
        return;
    }
    
    const filteredPeople = filterPeopleByDate(selectedDate);
    
    if (filteredPeople.length === 0) {
        alert("No hay ingresos registrados para la fecha seleccionada");
        return;
    }
    
    const formattedDate = new Date(selectedDate + 'T00:00:00').toLocaleDateString('es-ES');
    
    const inside = filteredPeople.filter(p => !p.exitTime).length;
    const exit = filteredPeople.filter(p => p.exitTime).length;
    
    let message = `üèõÔ∏è *REGISTRO DE INGRESOS AL RECTORADO*\n`;
    message += `üìÖ *Fecha:* ${formattedDate}\n\n`;
    message += `üë• *Total:* ${filteredPeople.length}\n`;
    message += `‚úÖ *Dentro:* ${inside}\n`;
    message += `üö™ *Salieron:* ${exit}\n\n`;
    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
    
    filteredPeople.forEach((p, idx) => {
        const entryTime = p.entryTime ? new Date(p.entryTime).toLocaleTimeString("es-ES", {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        }) : "-";
        
        const exitTime = p.exitTime ? new Date(p.exitTime).toLocaleTimeString("es-ES", {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        }) : "-";
        
        const status = p.exitTime ? "üö™" : "‚úÖ";
        
        message += `${idx + 1}. *${p.name}* ${status}\n`;
        message += `   üè¢ Destino: ${p.destination || "-"}\n`;
        message += `   üïê Ingreso: ${entryTime}`;
        if (p.exitTime) {
            message += ` | Salida: ${exitTime}`;
        }
        message += `\n\n`;
    });
    
    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
    message += `üìä Generado: ${new Date().toLocaleString("es-ES")}`;
    
    const encoded = encodeURIComponent(message);
    const whatsappUrl = `https://wa.me/?text=${encoded}`;
    window.open(whatsappUrl, '_blank');
}

// ============================
// Generar PDF del d√≠a
// ============================
async function generateDatePDF() {
    const selectedDate = document.getElementById("reportDate").value;
    
    if (!selectedDate) {
        alert("Por favor seleccione una fecha");
        return;
    }
    
    const filteredPeople = filterPeopleByDate(selectedDate);
    
    if (filteredPeople.length === 0) {
        alert("No hay ingresos registrados para la fecha seleccionada");
        return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    const formattedDate = new Date(selectedDate + 'T00:00:00').toLocaleDateString('es-ES');
    
    const inside = filteredPeople.filter(p => !p.exitTime).length;
    const exit = filteredPeople.filter(p => p.exitTime).length;
    
    doc.setFontSize(16);
    doc.text('REGISTRO DE INGRESOS AL RECTORADO', 105, 20, { align: 'center' });
    
    doc.setFontSize(12);
    doc.text(`Fecha: ${formattedDate}`, 105, 28, { align: 'center' });
    
    doc.setFontSize(10);
    doc.text(`Total: ${filteredPeople.length} | Dentro: ${inside} | Salieron: ${exit}`, 105, 36, { align: 'center' });
    
    doc.line(20, 40, 190, 40);
    
    let y = 50;
    doc.setFontSize(8);
    
    doc.setFont(undefined, 'bold');
    doc.text('#', 20, y);
    doc.text('Nombre', 28, y);
    doc.text('Destino', 80, y);
    doc.text('Ingreso', 130, y);
    doc.text('Salida', 165, y);
    
    y += 5;
    doc.line(20, y, 190, y);
    y += 5;
    
    doc.setFont(undefined, 'normal');
    filteredPeople.forEach((p, idx) => {
        if (y > 270) {
            doc.addPage();
            y = 20;
        }
        
        const entryTime = p.entryTime ? new Date(p.entryTime).toLocaleTimeString("es-ES", {
            hour: "2-digit",
            minute: "2-digit"
        }) : "-";
        
        const exitTime = p.exitTime ? new Date(p.exitTime).toLocaleTimeString("es-ES", {
            hour: "2-digit",
            minute: "2-digit"
        }) : "-";
        
        const nombre = p.name.length > 22 ? p.name.substring(0, 19) + '...' : p.name;
        const destino = p.destination && p.destination.length > 20 ? p.destination.substring(0, 17) + '...' : (p.destination || "-");
        
        doc.text(`${idx + 1}`, 20, y);
        doc.text(nombre, 28, y);
        doc.text(destino, 80, y);
        doc.text(entryTime, 130, y);
        doc.text(exitTime, 165, y);
        
        y += 6;
    });
    
    y += 2;
    doc.line(20, y, 190, y);
    
    y += 8;
    doc.setFont(undefined, 'bold');
    doc.setFontSize(10);
    doc.text(`Total: ${filteredPeople.length} visitantes`, 20, y);
    
    doc.save(`Ingresos_Rectorado_${selectedDate}.pdf`);
}

// ============================
// Exportar base como JSON
// ============================
function exportBaseJSON() {
    const dataStr = JSON.stringify(peopleBase, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "registro_ingresos_rectorado.json";
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }, 0);
}

// ============================
// Cargar base desde JSON
// ============================
function loadBaseJSON(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const loaded = JSON.parse(e.target.result);
            if (!Array.isArray(loaded)) throw new Error("Formato inv√°lido");

            const valid = loaded.every(p => p.name && p.entryTime);
            if (!valid) throw new Error("Faltan campos obligatorios");

            peopleBase = loaded;
            saveToLocalStorage();
            applyTableFilter();
            updateStats();
            updateDateFilterInfo();
            alert("‚úÖ Datos cargados exitosamente.");
        } catch (err) {
            alert("‚ùå Error al cargar datos: " + err.message);
        }
    };
    reader.readAsText(file);
    event.target.value = "";
}

// ============================
// Exportar informe general (Excel)
// ============================
async function exportAttendanceReport() {
    if (peopleBase.length === 0) {
        alert("No hay registros para exportar");
        return;
    }

    const ExcelJS = window.ExcelJS || await import('https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js');

    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet('Ingresos');

    worksheet.mergeCells('A1:E1');
    const titleCell = worksheet.getCell('A1');
    titleCell.value = 'REGISTRO GENERAL DE INGRESOS AL RECTORADO';
    titleCell.font = { bold: true, size: 14 };
    titleCell.alignment = { horizontal: 'center', vertical: 'middle' };
    titleCell.fill = {
        type: 'pattern',
        pattern: 'solid',
        fgColor: { argb: 'FFFFFF00' }
    };
    titleCell.border = {
        top: { style: 'thin' },
        left: { style: 'thin' },
        bottom: { style: 'thin' },
        right: { style: 'thin' }
    };

    ['B1', 'C1', 'D1', 'E1'].forEach(cell => {
        const c = worksheet.getCell(cell);
        c.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FFFFFF00' }
        };
        c.border = {
            top: { style: 'thin' },
            left: { style: 'thin' },
            bottom: { style: 'thin' },
            right: { style: 'thin' }
        };
    });

    const headers = ['#', 'Nombre del Visitante', 'Oficina/Unidad', 'Fecha y Hora de Ingreso', 'Fecha y Hora de Salida'];
    worksheet.getRow(2).values = headers;

    headers.forEach((header, index) => {
        const cell = worksheet.getRow(2).getCell(index + 1);
        cell.font = { bold: true };
        cell.alignment = { horizontal: 'center', vertical: 'middle' };
        cell.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FFFFFF00' }
        };
        cell.border = {
            top: { style: 'thin' },
            left: { style: 'thin' },
            bottom: { style: 'thin' },
            right: { style: 'thin' }
        };
    });

    let row = 3;
    peopleBase.forEach((p, idx) => {
        const entryTime = formatDateTime(p.entryTime);
        const exitTime = p.exitTime ? formatDateTime(p.exitTime) : "-";

        worksheet.getRow(row).values = [idx + 1, p.name, p.destination || "-", entryTime, exitTime];

        [1, 2, 3, 4, 5].forEach(col => {
            const cell = worksheet.getRow(row).getCell(col);
            cell.border = {
                top: { style: 'thin' },
                left: { style: 'thin' },
                bottom: { style: 'thin' },
                right: { style: 'thin' }
            };
        });

        row++;
    });

    const summaryRow = row + 1;
    const inside = peopleBase.filter(p => !p.exitTime).length;
    const exit = peopleBase.filter(p => p.exitTime).length;
    
    worksheet.getRow(summaryRow).values = [
        '',
        `TOTAL: ${peopleBase.length}`,
        `Dentro: ${inside}`,
        `Salieron: ${exit}`,
        ''
    ];

    [1, 2, 3, 4, 5].forEach(col => {
        const cell = worksheet.getRow(summaryRow).getCell(col);
        cell.font = { bold: true };
        cell.alignment = { horizontal: 'center', vertical: 'middle' };
        cell.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FFFFFF00' }
        };
        cell.border = {
            top: { style: 'thin' },
            left: { style: 'thin' },
            bottom: { style: 'thin' },
            right: { style: 'thin' }
        };
    });

    worksheet.getColumn(1).width = 8;
    worksheet.getColumn(2).width = 35;
    worksheet.getColumn(3).width = 30;
    worksheet.getColumn(4).width = 25;
    worksheet.getColumn(5).width = 25;

    const buffer = await workbook.xlsx.writeBuffer();
    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'REGISTRO_INGRESOS_RECTORADO.xlsx';
    a.click();
    window.URL.revokeObjectURL(url);
}

// ============================
// Enviar informe general por WhatsApp
// ============================
function sendReportByWhatsApp() {
    if (peopleBase.length === 0) {
        alert("No hay datos para enviar.");
        return;
    }

    const inside = peopleBase.filter(p => !p.exitTime).length;
    const exit = peopleBase.filter(p => p.exitTime).length;

    let message = `üèõÔ∏è *REGISTRO DE INGRESOS AL RECTORADO*\n\n`;
    message += `üë• *Total:* ${peopleBase.length}\n`;
    message += `‚úÖ *Dentro:* ${inside}\n`;
    message += `üö™ *Salieron:* ${exit}\n\n`;
    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;

    const MAX = 20;
    const list = peopleBase.slice(0, MAX);

    list.forEach((p, idx) => {
        const entryTime = p.entryTime ? new Date(p.entryTime).toLocaleString("es-ES", {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        }) : "-";
        
        const exitTime = p.exitTime ? new Date(p.exitTime).toLocaleTimeString("es-ES", {
            hour: '2-digit',
            minute: '2-digit'
        }) : "-";

        const status = p.exitTime ? "üö™" : "‚úÖ";

        message += `${idx + 1}. *${p.name}* ${status}\n`;
        message += `   üè¢ Destino: ${p.destination || "-"}\n`;
        message += `   üïê ${entryTime}`;
        if (p.exitTime) {
            message += ` | üö™ ${exitTime}`;
        }
        message += `\n\n`;
    });

    if (peopleBase.length > MAX) {
        message += `... y ${peopleBase.length - MAX} m√°s.\n\n`;
    }

    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
    message += `üìÖ Generado: ${new Date().toLocaleString("es-ES")}`;

    const encoded = encodeURIComponent(message);
    const whatsappUrl = `https://wa.me/?text=${encoded}`;
    window.open(whatsappUrl, '_blank');
}
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>

</body>
</html>



<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Control de Asistencia</title>

<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">

<style>
:root{
  --bg:#020617;
  --card:#020617;
  --border:#1e293b;
  --text:#e5e7eb;
  --muted:#94a3b8;
}

body{
  background: radial-gradient(circle at top,#1e293b,#020617);
  min-height:100vh;
  color:var(--text);
  padding:20px;
}

.main-card{
  background:var(--card);
  border-radius:16px;
  border:1px solid var(--border);
  box-shadow:0 20px 40px rgba(0,0,0,.6);
}

.stat-card{
  border:1px solid var(--border);
  border-radius:12px;
  padding:20px;
  text-align:center;
}

.person-card{
  border:1px solid var(--border);
  border-radius:12px;
  padding:15px;
  margin-bottom:15px;
}

.filter-card{
  border:1px solid var(--border);
  border-radius:12px;
  padding:20px;
  margin-bottom:20px;
  background: rgba(30, 41, 59, 0.5);
}

.form-control,.input-group-text{
  background:#020617;
  border:1px solid var(--border);
  color:var(--text);
}

.form-control::placeholder{color:var(--muted);}

.status-badge{
  padding:6px 14px;
  border-radius:999px;
  font-size:.8rem;
  font-weight:600;
}
.status-present{background:#064e3b;color:#6ee7b7;}
.status-absent{background:#7c2d12;color:#fdba74;}
.text-muted{color:rgb(117, 116, 116) !important;}

.btn-group-custom {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.time-info {
  font-size: 0.85rem;
  color: var(--muted);
  margin-top: 5px;
}
</style>
</head>

<body>
<div class="container">
<div class="main-card p-4">

<!-- HEADER -->
<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
<h4><i class="fas fa-clipboard-check text-primary"></i> Control de Asistencia</h4>

<div class="d-flex gap-2 flex-wrap">
<label class="btn btn-secondary mb-0">
<i class="fas fa-folder-open"></i> Cargar JSON
<input type="file" accept=".json" hidden onchange="loadBaseJSON(event)">
</label>

<button class="btn btn-primary" onclick="exportBaseJSON()">
<i class="fas fa-file-code"></i> Exportar JSON
</button>

<button class="btn btn-info" onclick="exportAttendanceReport()">
<i class="fas fa-file-alt"></i> Informe
</button>

<button class="btn btn-success" onclick="sendReportByWhatsApp()">
  <i class="fab fa-whatsapp"></i> WhatsApp
</button>

</div>
</div>

<!-- STATS -->
<div class="row mb-4 text-center">
<div class="col-md-4"><div class="stat-card"><h5 id="totalPersons">0</h5><small>Total Registrados</small></div></div>
<div class="col-md-4"><div class="stat-card"><h5 id="totalPresent">0</h5><small>Presentes (Dentro)</small></div></div>
<div class="col-md-4"><div class="stat-card"><h5 id="totalAbsent">0</h5><small>Salieron</small></div></div>
</div>

<!-- TABS -->
<ul class="nav nav-tabs mb-3">
<li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#control">Control</button></li>
<li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#register">Registrar</button></li>
</ul>

<div class="tab-content">

<!-- CONTROL -->
<div class="tab-pane fade show active" id="control">

<!-- FILTRO DE FECHA PARA REPORTES -->
<div class="filter-card">
  <div class="row align-items-end">
    <div class="col-md-4">
      <label class="form-label"><i class="fas fa-calendar"></i> Seleccionar Fecha</label>
      <input type="date" id="reportDate" class="form-control" value="">
    </div>
    <div class="col-md-8">
      <div class="btn-group-custom">
        <button class="btn btn-info" onclick="generateDateReport()">
          <i class="fas fa-file-alt"></i> Informe del D√≠a
        </button>
        <button class="btn btn-success" onclick="sendDateReportByWhatsApp()">
          <i class="fab fa-whatsapp"></i> WhatsApp del D√≠a
        </button>
        <button class="btn btn-warning" onclick="generateDatePDF()">
          <i class="fas fa-file-pdf"></i> PDF del D√≠a
        </button>
        <button class="btn btn-secondary" onclick="clearDateFilter()">
          <i class="fas fa-times"></i> Limpiar Fecha
        </button>
      </div>
    </div>
  </div>
</div>

<!-- BUSCADOR -->
<div class="mb-3">
  <input id="searchInput" class="form-control" placeholder="Buscar por nombre" 
         oninput="filterPeople(this.value)">
</div>

<div id="personsList"></div>
</div>

<!-- REGISTER -->
<div class="tab-pane fade" id="register">
<div class="row justify-content-center">
<div class="col-md-6">
<div class="card bg-dark text-light">
<div class="card-body">
<h5 class="mb-3">Registrar Ingreso</h5>
<div class="alert alert-info">
  <i class="fas fa-info-circle"></i> Al registrar el nombre, se marca autom√°ticamente la entrada con fecha y hora.
</div>
<input class="form-control mb-3" id="inputName" placeholder="Nombre completo">
<button class="btn btn-primary w-100" onclick="addPerson()">
  <i class="fas fa-user-plus"></i> Registrar Ingreso
</button>
</div>
</div>
</div>
</div>
</div>

</div>
</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>

// ============================
// Estado inicial de la base
// ============================
let peopleBase = JSON.parse(localStorage.getItem("attendanceBase")) || [];

// ============================
// Al cargar la p√°gina
// ============================
document.addEventListener("DOMContentLoaded", () => {
    // Establecer fecha de hoy por defecto
    const today = new Date().toISOString().split('T')[0];
    document.getElementById("reportDate").value = today;
    
    renderPersons(peopleBase);
    updateStats();
});

// ============================
// Renderizar lista de personas
// ============================
function renderPersons(list) {
    const container = document.getElementById("personsList");
    container.innerHTML = "";

    if (list.length === 0) {
        container.innerHTML = `<p class="text-muted">No hay personas registradas.</p>`;
        return;
    }

    list.forEach((person, index) => {
        const status = person.status || "present";
        const statusClass = status === "present" ? "status-present" : "status-absent";
        const statusText = status === "present" ? "Presente (Dentro)" : "Sali√≥";

        // Formatear entrada (siempre existe)
        const entryInfo = `<div class="time-info"><i class="fas fa-sign-in-alt text-success"></i> Entrada: ${formatDateTime(person.entryTime)}</div>`;
        
        // Formatear salida
        let exitInfo = "";
        if (person.exitTime) {
            exitInfo = `<div class="time-info"><i class="fas fa-sign-out-alt text-warning"></i> Salida: ${formatDateTime(person.exitTime)}</div>`;
        }

        const card = document.createElement("div");
        card.className = "person-card";
        card.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <strong>${index + 1}. ${person.name}</strong>
                    ${entryInfo}
                    ${exitInfo}
                </div>
                <div class="text-end">
                    <span class="status-badge ${statusClass}">${statusText}</span><br>
                    <div class="btn-group mt-2" role="group">
                        <button class="btn btn-sm btn-warning" onclick="markExit(${index})"
                                ${status !== "present" ? 'disabled' : ''}>
                            <i class="fas fa-sign-out-alt"></i> Salida
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deletePerson(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(card);
    });
}

// Funci√≥n auxiliar para mostrar fechas y horas legibles
function formatDateTime(isoString) {
    if (!isoString) return "-";
    const date = new Date(isoString);
    if (isNaN(date.getTime())) return isoString;
    return date.toLocaleString("es-ES", {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
}

// ============================
// Marcar salida
// ============================
function markExit(index) {
    const now = new Date().toISOString();
    peopleBase[index].exitTime = now;
    peopleBase[index].status = "absent";
    
    saveToLocalStorage();
    renderFilteredPersons();
    updateStats();
}

// ============================
// Eliminar persona
// ============================
function deletePerson(index) {
    if (confirm(`¬øEst√° seguro de eliminar a ${peopleBase[index].name}?`)) {
        peopleBase.splice(index, 1);
        saveToLocalStorage();
        renderFilteredPersons();
        updateStats();
    }
}

// ============================
// Filtrar personas (b√∫squeda)
// ============================
function filterPeople(query) {
    const lowerQuery = query.toLowerCase().trim();
    const filtered = peopleBase.filter(p => 
        p.name.toLowerCase().includes(lowerQuery)
    );
    renderPersons(filtered);
}

// ============================
// Renderizar sin filtro (despu√©s de cambios)
// ============================
function renderFilteredPersons() {
    const query = document.getElementById("searchInput").value;
    if (query) {
        filterPeople(query);
    } else {
        renderPersons(peopleBase);
    }
}

// ============================
// Filtrar personas por fecha
// ============================
function filterPeopleByDate(targetDate) {
    if (!targetDate) return peopleBase;
    
    const target = new Date(targetDate);
    target.setHours(0, 0, 0, 0);
    
    return peopleBase.filter(p => {
        if (p.entryTime) {
            const entryDate = new Date(p.entryTime);
            entryDate.setHours(0, 0, 0, 0);
            return entryDate.getTime() === target.getTime();
        }
        return false;
    });
}

// ============================
// Limpiar filtro de fecha
// ============================
function clearDateFilter() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById("reportDate").value = today;
}

// ============================
// Registrar persona (CON ENTRADA AUTOM√ÅTICA)
// ============================
function addPerson() {
    const name = document.getElementById("inputName").value.trim();

    if (!name) {
        alert("Por favor, ingrese el nombre completo.");
        return;
    }

    const now = new Date().toISOString();

    const newPerson = {
        name,
        entryTime: now, // Entrada autom√°tica al registrar
        exitTime: null,
        status: "present" // Entra como presente autom√°ticamente
    };

    peopleBase.push(newPerson);
    saveToLocalStorage();
    renderFilteredPersons();
    updateStats();

    // Limpiar
    document.getElementById("inputName").value = "";

    // Cambiar pesta√±a
    const controlTab = new bootstrap.Tab(document.querySelector('.nav-link[data-bs-target="#control"]'));
    controlTab.show();
    
    alert(`‚úÖ ${name} registrado con entrada autom√°tica.`);
}

// ============================
// Guardar en localStorage
// ============================
function saveToLocalStorage() {
    localStorage.setItem("attendanceBase", JSON.stringify(peopleBase));
}

// ============================
// Actualizar estad√≠sticas
// ============================
function updateStats() {
    const total = peopleBase.length;
    const present = peopleBase.filter(p => p.status === "present").length;
    const absent = peopleBase.filter(p => p.status === "absent").length;

    document.getElementById("totalPersons").textContent = total;
    document.getElementById("totalPresent").textContent = present;
    document.getElementById("totalAbsent").textContent = absent;
}

// ============================
// Generar informe del d√≠a (Excel)
// ============================
async function generateDateReport() {
    const selectedDate = document.getElementById("reportDate").value;
    
    if (!selectedDate) {
        alert("Por favor seleccione una fecha");
        return;
    }
    
    const filteredPeople = filterPeopleByDate(selectedDate);
    
    if (filteredPeople.length === 0) {
        alert("No hay registros de asistencia para la fecha seleccionada");
        return;
    }
    
    const ExcelJS = window.ExcelJS || await import('https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js');
    
    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet('Asistencia');
    
    const formattedDate = new Date(selectedDate).toLocaleDateString('es-ES');
    
    // T√çTULO
    worksheet.mergeCells('A1:D1');
    const titleCell = worksheet.getCell('A1');
    titleCell.value = `LISTA DE ASISTENCIA - ${formattedDate}`;
    titleCell.font = { bold: true, size: 14 };
    titleCell.alignment = { horizontal: 'center', vertical: 'middle' };
    titleCell.fill = {
        type: 'pattern',
        pattern: 'solid',
        fgColor: { argb: 'FFFFFF00' }
    };
    titleCell.border = {
        top: { style: 'thin' },
        left: { style: 'thin' },
        bottom: { style: 'thin' },
        right: { style: 'thin' }
    };
    
    ['B1', 'C1', 'D1'].forEach(cell => {
        const c = worksheet.getCell(cell);
        c.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FFFFFF00' }
        };
        c.border = {
            top: { style: 'thin' },
            left: { style: 'thin' },
            bottom: { style: 'thin' },
            right: { style: 'thin' }
        };
    });
    
    // ENCABEZADOS
    const headers = ['Nombre completo', 'Hora de entrada', 'Hora de salida', 'Estado'];
    worksheet.getRow(2).values = headers;
    
    headers.forEach((header, index) => {
        const cell = worksheet.getCell(2, index + 1);
        cell.font = { bold: true };
        cell.alignment = { horizontal: 'center', vertical: 'middle' };
        cell.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FFFFFF00' }
        };
        cell.border = {
            top: { style: 'thin' },
            left: { style: 'thin' },
            bottom: { style: 'thin' },
            right: { style: 'thin' }
        };
    });
    
    // DATOS
    let row = 3;
    filteredPeople.forEach(p => {
        const entryTime = p.entryTime ? new Date(p.entryTime).toLocaleString("es-ES", {
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit"
        }) : "-";
        
        const exitTime = p.exitTime ? new Date(p.exitTime).toLocaleString("es-ES", {
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit"
        }) : "-";
        
        const estado = p.status === "present" ? "Presente" : "Sali√≥";
        
        worksheet.getRow(row).values = [p.name, entryTime, exitTime, estado];
        
        [1, 2, 3, 4].forEach(col => {
            const cell = worksheet.getCell(row, col);
            cell.border = {
                top: { style: 'thin' },
                left: { style: 'thin' },
                bottom: { style: 'thin' },
                right: { style: 'thin' }
            };
        });
        
        row++;
    });
    
    // RESUMEN
    const summaryRow = row + 1;
    const presentCount = filteredPeople.filter(p => p.status === "present").length;
    const absentCount = filteredPeople.filter(p => p.status === "absent").length;
    
    worksheet.getRow(summaryRow).values = [
        `TOTAL: ${filteredPeople.length}`,
        `Presentes: ${presentCount}`,
        `Salieron: ${absentCount}`,
        ''
    ];
    
    [1, 2, 3, 4].forEach(col => {
        const cell = worksheet.getCell(summaryRow, col);
        cell.font = { bold: true };
        cell.alignment = { horizontal: 'center', vertical: 'middle' };
        cell.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FFFFFF00' }
        };
        cell.border = {
            top: { style: 'thin' },
            left: { style: 'thin' },
            bottom: { style: 'thin' },
            right: { style: 'thin' }
        };
    });
    
    worksheet.getColumn(1).width = 35;
    worksheet.getColumn(2).width = 20;
    worksheet.getColumn(3).width = 20;
    worksheet.getColumn(4).width = 15;
    
    const buffer = await workbook.xlsx.writeBuffer();
    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Asistencia_${selectedDate}.xlsx`;
    a.click();
    window.URL.revokeObjectURL(url);
}

// ============================
// Enviar reporte del d√≠a por WhatsApp
// ============================
function sendDateReportByWhatsApp() {
    const selectedDate = document.getElementById("reportDate").value;
    
    if (!selectedDate) {
        alert("Por favor seleccione una fecha");
        return;
    }
    
    const filteredPeople = filterPeopleByDate(selectedDate);
    
    if (filteredPeople.length === 0) {
        alert("No hay registros de asistencia para la fecha seleccionada");
        return;
    }
    
    const formattedDate = new Date(selectedDate).toLocaleDateString('es-ES');
    
    const presentCount = filteredPeople.filter(p => p.status === "present").length;
    const absentCount = filteredPeople.filter(p => p.status === "absent").length;
    
    let message = `üìÑ *INFORME DE ASISTENCIA*\n`;
    message += `üìÖ *Fecha:* ${formattedDate}\n\n`;
    message += `üë• *Total:* ${filteredPeople.length}\n`;
    message += `‚úÖ *Presentes:* ${presentCount}\n`;
    message += `üö™ *Salieron:* ${absentCount}\n\n`;
    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
    
    filteredPeople.forEach((p, idx) => {
        const entryTime = p.entryTime ? new Date(p.entryTime).toLocaleTimeString("es-ES", {
            hour: '2-digit',
            minute: '2-digit'
        }) : "-";
        
        const exitTime = p.exitTime ? new Date(p.exitTime).toLocaleTimeString("es-ES", {
            hour: '2-digit',
            minute: '2-digit'
        }) : "-";
        
        const estado = p.status === "present" ? "‚úÖ" : "üö™";
        
        message += `${idx + 1}. *${p.name}* ${estado}\n`;
        message += `   üïê Entrada: ${entryTime}`;
        if (exitTime !== "-") {
            message += ` | Salida: ${exitTime}`;
        }
        message += `\n\n`;
    });
    
    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
    message += `üìä Generado: ${new Date().toLocaleString("es-ES")}`;
    
    const encoded = encodeURIComponent(message);
    const whatsappUrl = `https://wa.me/?text=${encoded}`;
    window.open(whatsappUrl, '_blank');
}

// ============================
// Generar PDF del d√≠a
// ============================
async function generateDatePDF() {
    const selectedDate = document.getElementById("reportDate").value;
    
    if (!selectedDate) {
        alert("Por favor seleccione una fecha");
        return;
    }
    
    const filteredPeople = filterPeopleByDate(selectedDate);
    
    if (filteredPeople.length === 0) {
        alert("No hay registros de asistencia para la fecha seleccionada");
        return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    const formattedDate = new Date(selectedDate).toLocaleDateString('es-ES');
    
    const presentCount = filteredPeople.filter(p => p.status === "present").length;
    const absentCount = filteredPeople.filter(p => p.status === "absent").length;
    
    // T√≠tulo
    doc.setFontSize(16);
    doc.text('LISTA DE ASISTENCIA', 105, 20, { align: 'center' });
    
    doc.setFontSize(12);
    doc.text(`Fecha: ${formattedDate}`, 105, 28, { align: 'center' });
    
    // Resumen
    doc.setFontSize(10);
    doc.text(`Total: ${filteredPeople.length} | Presentes: ${presentCount} | Salieron: ${absentCount}`, 105, 36, { align: 'center' });
    
    // L√≠nea separadora
    doc.line(20, 40, 190, 40);
    
    // Tabla
    let y = 50;
    doc.setFontSize(9);
    
    // Encabezados
    doc.setFont(undefined, 'bold');
    doc.text('#', 20, y);
    doc.text('Nombre', 30, y);
    doc.text('Entrada', 120, y);
    doc.text('Salida', 155, y);
    doc.text('Estado', 180, y);
    
    y += 5;
    doc.line(20, y, 190, y);
    y += 5;
    
    // Datos
    doc.setFont(undefined, 'normal');
    filteredPeople.forEach((p, idx) => {
        if (y > 270) {
            doc.addPage();
            y = 20;
        }
        
        const entryTime = p.entryTime ? new Date(p.entryTime).toLocaleTimeString("es-ES", {
            hour: "2-digit",
            minute: "2-digit"
        }) : "-";
        
        const exitTime = p.exitTime ? new Date(p.exitTime).toLocaleTimeString("es-ES", {
            hour: "2-digit",
            minute: "2-digit"
        }) : "-";
        
        const estado = p.status === "present" ? "Dentro" : "Salio";
        
        const nombre = p.name.length > 35 ? p.name.substring(0, 32) + '...' : p.name;
        
        doc.text(`${idx + 1}`, 20, y);
        doc.text(nombre, 30, y);
        doc.text(entryTime, 120, y);
        doc.text(exitTime, 155, y);
        doc.text(estado, 180, y);
        
        y += 6;
    });
    
    // L√≠nea final
    y += 2;
    doc.line(20, y, 190, y);
    
    // Pie de p√°gina
    y += 8;
    doc.setFont(undefined, 'bold');
    doc.setFontSize(10);
    doc.text(`Total registrados: ${filteredPeople.length}`, 20, y);
    
    doc.save(`Asistencia_${selectedDate}.pdf`);
}

// ============================
// Exportar base como JSON
// ============================
function exportBaseJSON() {
    const dataStr = JSON.stringify(peopleBase, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "asistencia_base.json";
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }, 0);
}

// ============================
// Cargar base desde JSON
// ============================
function loadBaseJSON(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const loaded = JSON.parse(e.target.result);
            if (!Array.isArray(loaded)) throw new Error("Formato inv√°lido");

            const valid = loaded.every(p => p.name && p.entryTime);
            if (!valid) throw new Error("Faltan campos obligatorios");

            peopleBase = loaded;
            saveToLocalStorage();
            renderFilteredPersons();
            updateStats();
            alert("‚úÖ Base cargada exitosamente.");
        } catch (err) {
            alert("‚ùå Error al cargar JSON: " + err.message);
        }
    };
    reader.readAsText(file);
    event.target.value = "";
}

// ============================
// Exportar informe de asistencia (Excel)
// ============================
async function exportAttendanceReport() {
    const total = peopleBase.length;
    const present = peopleBase.filter(p => p.status === "present").length;
    const absent = peopleBase.filter(p => p.status === "absent").length;

    const ExcelJS = window.ExcelJS || await import('https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js');

    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet('Asistencia');

    worksheet.mergeCells('A1:D1');
    const titleCell = worksheet.getCell('A1');
    titleCell.value = 'LISTA DE ASISTENCIA GENERAL';
    titleCell.font = { bold: true, size: 14 };
    titleCell.alignment = { horizontal: 'center', vertical: 'middle' };
    titleCell.fill = {
        type: 'pattern',
        pattern: 'solid',
        fgColor: { argb: 'FFFFFF00' }
    };
    titleCell.border = {
        top: { style: 'thin' },
        left: { style: 'thin' },
        bottom: { style: 'thin' },
        right: { style: 'thin' }
    };

    ['B1', 'C1', 'D1'].forEach(cell => {
        const c = worksheet.getCell(cell);
        c.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FFFFFF00' }
        };
        c.border = {
            top: { style: 'thin' },
            left: { style: 'thin' },
            bottom: { style: 'thin' },
            right: { style: 'thin' }
        };
    });

    const headers = ['Nombre completo', 'Hora de entrada', 'Hora de salida', 'Estado'];
    worksheet.getRow(2).values = headers;

    headers.forEach((header, index) => {
        const cell = worksheet.getCell(2, index + 1);
        cell.font = { bold: true };
        cell.alignment = { horizontal: 'center', vertical: 'middle' };
        cell.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FFFFFF00' }
        };
        cell.border = {
            top: { style: 'thin' },
            left: { style: 'thin' },
            bottom: { style: 'thin' },
            right: { style: 'thin' }
        };
    });

    let row = 3;
    peopleBase.forEach(p => {
        const entryTime = p.entryTime ? formatDateTime(p.entryTime) : "-";
        const exitTime = p.exitTime ? formatDateTime(p.exitTime) : "-";
        const estado = p.status === "present" ? "Presente" : "Sali√≥";

        worksheet.getRow(row).values = [p.name, entryTime, exitTime, estado];

        [1, 2, 3, 4].forEach(col => {
            const cell = worksheet.getCell(row, col);
            cell.border = {
                top: { style: 'thin' },
                left: { style: 'thin' },
                bottom: { style: 'thin' },
                right: { style: 'thin' }
            };
        });

        row++;
    });

    const summaryRow = row + 1;
    worksheet.getRow(summaryRow).values = [
        `TOTAL: ${total}`,
        `‚úÖ Presentes: ${present}`,
        `üö™ Salieron: ${absent}`,
        ''
    ];

    [1, 2, 3, 4].forEach(col => {
        const cell = worksheet.getCell(summaryRow, col);
        cell.font = { bold: true };
        cell.alignment = { horizontal: 'center', vertical: 'middle' };
        cell.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FFFFFF00' }
        };
        cell.border = {
            top: { style: 'thin' },
            left: { style: 'thin' },
            bottom: { style: 'thin' },
            right: { style: 'thin' }
        };
    });

    worksheet.getColumn(1).width = 35;
    worksheet.getColumn(2).width = 25;
    worksheet.getColumn(3).width = 25;
    worksheet.getColumn(4).width = 15;

    const buffer = await workbook.xlsx.writeBuffer();
    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'LISTA_DE_ASISTENCIA_GENERAL.xlsx';
    a.click();
    window.URL.revokeObjectURL(url);
}

// ============================
// Enviar informe por WhatsApp
// ============================
function sendReportByWhatsApp() {
    if (peopleBase.length === 0) {
        alert("No hay datos para enviar.");
        return;
    }

    const total = peopleBase.length;
    const present = peopleBase.filter(p => p.status === "present").length;
    const absent = peopleBase.filter(p => p.status === "absent").length;

    let message = `üìÑ *INFORME DE ASISTENCIA GENERAL*\n\n`;
    message += `üë• *Total:* ${total}\n`;
    message += `‚úÖ *Presentes (Dentro):* ${present}\n`;
    message += `üö™ *Salieron:* ${absent}\n\n`;
    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;

    const MAX = 20;
    const list = peopleBase.slice(0, MAX);

    list.forEach((p, idx) => {
        const entryTime = p.entryTime ? new Date(p.entryTime).toLocaleString("es-ES", {
            day: '2-digit',
            month: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        }) : "-";
        
        const exitTime = p.exitTime ? new Date(p.exitTime).toLocaleTimeString("es-ES", {
            hour: '2-digit',
            minute: '2-digit'
        }) : "-";

        const estado = p.status === "present" ? "‚úÖ" : "üö™";

        message += `${idx + 1}. *${p.name}* ${estado}\n`;
        message += `   üïê ${entryTime}`;
        if (exitTime !== "-") {
            message += ` | üö™ ${exitTime}`;
        }
        message += `\n\n`;
    });

    if (peopleBase.length > MAX) {
        message += `... y ${peopleBase.length - MAX} m√°s.\n\n`;
    }

    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
    message += `üìÖ Generado: ${new Date().toLocaleString("es-ES")}`;

    const encoded = encodeURIComponent(message);
    const whatsappUrl = `https://wa.me/?text=${encoded}`;
    window.open(whatsappUrl, '_blank');
}
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>

</body>
</html>

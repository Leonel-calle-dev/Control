
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Control de Asistencia</title>

<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">

<style>
:root{
  --bg:#020617;
  --card:#020617;
  --border:#1e293b;
  --text:#e5e7eb;
  --muted:#94a3b8;
}

body{
  background: radial-gradient(circle at top,#1e293b,#020617);
  min-height:100vh;
  color:var(--text);
  padding:20px;
}

.main-card{
  background:var(--card);
  border-radius:16px;
  border:1px solid var(--border);
  box-shadow:0 20px 40px rgba(0,0,0,.6);
}

.stat-card{
  border:1px solid var(--border);
  border-radius:12px;
  padding:20px;
  text-align:center;
}

.person-card{
  border:1px solid var(--border);
  border-radius:12px;
  padding:15px;
  margin-bottom:15px;
}

.filter-card{
  border:1px solid var(--border);
  border-radius:12px;
  padding:20px;
  margin-bottom:20px;
  background: rgba(30, 41, 59, 0.5);
}

.form-control,.input-group-text{
  background:#020617;
  border:1px solid var(--border);
  color:var(--text);
}

.form-control::placeholder{color:var(--muted);}

.status-badge{
  padding:6px 14px;
  border-radius:999px;
  font-size:.8rem;
  font-weight:600;
}
.status-present{background:#064e3b;color:#6ee7b7;}
.status-absent{background:#7c2d12;color:#fdba74;}
.status-not-arrived{background:#334155;color:#cbd5f5;}
.text-muted{color:rgb(117, 116, 116) !important;}

.btn-group-custom {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}
</style>
</head>

<body>
<div class="container">
<div class="main-card p-4">

<!-- HEADER -->
<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
<h4><i class="fas fa-clipboard-check text-primary"></i> Control de Asistencia</h4>

<div class="d-flex gap-2 flex-wrap">
<label class="btn btn-secondary mb-0">
<i class="fas fa-folder-open"></i> Cargar JSON
<input type="file" accept=".json" hidden onchange="loadBaseJSON(event)">
</label>

<button class="btn btn-primary" onclick="exportBaseJSON()">
<i class="fas fa-file-code"></i> Exportar JSON
</button>

<label class="btn btn-success mb-0">
<i class="fas fa-file-excel"></i> Importar Excel
<input type="file" accept=".xlsx,.xls" hidden onchange="importExcel(event)">
</label>

<button class="btn btn-info" onclick="exportAttendanceReport()">
<i class="fas fa-file-alt"></i> Informe
</button>

<button class="btn btn-success" onclick="sendReportByWhatsApp()">
  <i class="fab fa-whatsapp"></i> WhatsApp
</button>

</div>
</div>

<!-- STATS -->
<div class="row mb-4 text-center">
<div class="col-md-3"><div class="stat-card"><h5 id="totalPersons">0</h5><small>Total</small></div></div>
<div class="col-md-3"><div class="stat-card"><h5 id="totalPresent">0</h5><small>Presentes</small></div></div>
<div class="col-md-3"><div class="stat-card"><h5 id="totalAbsent">0</h5><small>Salieron</small></div></div>
<div class="col-md-3"><div class="stat-card"><h5 id="totalNotArrived">0</h5><small>No llegaron</small></div></div>
</div>

<!-- TABS -->
<ul class="nav nav-tabs mb-3">
<li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#control">Control</button></li>
<li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#register">Registrar</button></li>
</ul>

<div class="tab-content">

<!-- CONTROL -->
<div class="tab-pane fade show active" id="control">

<!-- FILTRO DE FECHA PARA REPORTES -->
<div class="filter-card">
  <div class="row align-items-end">
    <div class="col-md-4">
      <label class="form-label"><i class="fas fa-calendar"></i> Seleccionar Fecha</label>
      <input type="date" id="reportDate" class="form-control" value="">
    </div>
    <div class="col-md-8">
      <div class="btn-group-custom">
        <button class="btn btn-info" onclick="generateDateReport()">
          <i class="fas fa-file-alt"></i> Informe del D√≠a
        </button>
        <button class="btn btn-success" onclick="sendDateReportByWhatsApp()">
          <i class="fab fa-whatsapp"></i> WhatsApp del D√≠a
        </button>
        <button class="btn btn-warning" onclick="generateDatePDF()">
          <i class="fas fa-file-pdf"></i> PDF del D√≠a
        </button>
        <button class="btn btn-secondary" onclick="clearDateFilter()">
          <i class="fas fa-times"></i> Limpiar Fecha
        </button>
      </div>
    </div>
  </div>
  <div id="dateFilterInfo" class="mt-2 text-muted small"></div>
</div>

<!-- BUSCADOR -->
<div class="mb-3">
  <input id="searchInput" class="form-control" placeholder="Buscar por nombre o CI" 
         oninput="filterPeople(this.value)">
</div>

<div id="personsList"></div>
</div>

<!-- REGISTER -->
<div class="tab-pane fade" id="register">
<div class="row justify-content-center">
<div class="col-md-6">
<div class="card bg-dark text-light">
<div class="card-body">
<h5>Registrar Persona</h5>
<input class="form-control mb-2" id="inputName" placeholder="Nombre completo">
<input class="form-control mb-2" id="inputCI" placeholder="CI">
<input class="form-control mb-2" type="date" id="inputBirthDate">
<input class="form-control mb-2" id="inputPhone" placeholder="Celular">
<input class="form-control mb-3" id="inputEmail" placeholder="Correo">
<button class="btn btn-primary w-100" onclick="addPerson()">Registrar</button>
</div>
</div>
</div>
</div>
</div>

</div>
</div>
</div>

<script>

// ============================
// Estado inicial de la base
// ============================
let peopleBase = JSON.parse(localStorage.getItem("attendanceBase")) || [];

// ============================
// Al cargar la p√°gina
// ============================
document.addEventListener("DOMContentLoaded", () => {
    // Establecer fecha de hoy por defecto
    const today = new Date().toISOString().split('T')[0];
    document.getElementById("reportDate").value = today;
    
    renderPersons(peopleBase);
    updateStats();
});

// ============================
// Renderizar lista de personas
// ============================
function renderPersons(list) {
    const container = document.getElementById("personsList");
    container.innerHTML = "";

    if (list.length === 0) {
        container.innerHTML = `<p class="text-muted">No hay personas registradas.</p>`;
        return;
    }

    list.forEach((person, index) => {
        const status = person.status || "not-arrived";
        const statusClass = 
            status === "present" ? "status-present" : 
            status === "absent" ? "status-absent" : "status-not-arrived";
        const statusText = 
            status === "present" ? "Presente" : 
            status === "absent" ? "Sali√≥" : "No lleg√≥";

        const formattedBirth = formatDateDisplay(person.birthDate);

        const card = document.createElement("div");
        card.className = "person-card";
        card.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong>${index + 1}. ${person.name}</strong><br>
                    <small class="text-muted">CI: ${person.ci} | ${formattedBirth}</small><br>
                    <small>${person.phone || "-"} | ${person.email || "-"}</small>
                </div>
                <div class="text-end">
                    <span class="status-badge ${statusClass}">${statusText}</span><br>
                    <div class="btn-group mt-2" role="group">
                        <button class="btn btn-sm btn-success" onclick="updateStatus(${index}, 'present')">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="updateStatus(${index}, 'absent')">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                        <button class="btn btn-sm btn-secondary" onclick="updateStatus(${index}, 'not-arrived')">
                            <i class="fas fa-clock"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(card);
    });
}

// Funci√≥n auxiliar para mostrar fechas legibles
function formatDateDisplay(dateStr) {
    if (!dateStr) return "-";
    const date = new Date(dateStr);
    if (isNaN(date.getTime())) return dateStr;
    return date.toLocaleDateString("es-ES");
}

// ============================
// Actualizar estado de asistencia
// ============================

function updateStatus(index, status) {
    const now = new Date().toISOString();

    if (status === "present") {
        if (peopleBase[index].status !== "present") {
            peopleBase[index].entryTime = now;
        }
    }

    peopleBase[index].status = status;
    saveToLocalStorage();
    renderFilteredPersons();
    updateStats();
}

// ============================
// Filtrar personas (b√∫squeda)
// ============================
function filterPeople(query) {
    const lowerQuery = query.toLowerCase().trim();
    const filtered = peopleBase.filter(p => 
        p.name.toLowerCase().includes(lowerQuery) ||
        p.ci.toLowerCase().includes(lowerQuery)
    );
    renderPersons(filtered);
}

// ============================
// Renderizar sin filtro (despu√©s de cambios)
// ============================
function renderFilteredPersons() {
    const query = document.getElementById("searchInput").value;
    if (query) {
        filterPeople(query);
    } else {
        renderPersons(peopleBase);
    }
}

// ============================
// Filtrar personas por fecha
// ============================
function filterPeopleByDate(targetDate) {
    if (!targetDate) return peopleBase;
    
    const target = new Date(targetDate);
    target.setHours(0, 0, 0, 0);
    
    return peopleBase.filter(p => {
        if (p.status === "present" && p.entryTime) {
            const entryDate = new Date(p.entryTime);
            entryDate.setHours(0, 0, 0, 0);
            return entryDate.getTime() === target.getTime();
        }
        return false;
    });
}

// ============================
// Limpiar filtro de fecha
// ============================
function clearDateFilter() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById("reportDate").value = today;
    document.getElementById("dateFilterInfo").innerHTML = "";
}

// ============================
// Generar informe del d√≠a
// ============================
async function generateDateReport() {
    const selectedDate = document.getElementById("reportDate").value;
    
    if (!selectedDate) {
        alert("Por favor seleccione una fecha");
        return;
    }
    
    const filteredPeople = filterPeopleByDate(selectedDate);
    
    if (filteredPeople.length === 0) {
        alert("No hay registros de asistencia para la fecha seleccionada");
        return;
    }
    
    const ExcelJS = window.ExcelJS || await import('https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js');
    
    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet('Asistencia');
    
    const formattedDate = new Date(selectedDate).toLocaleDateString('es-ES');
    
    // T√çTULO
    worksheet.mergeCells('A1:C1');
    const titleCell = worksheet.getCell('A1');
    titleCell.value = `LISTA DE ASISTENCIA - ${formattedDate}`;
    titleCell.font = { bold: true, size: 14 };
    titleCell.alignment = { horizontal: 'center', vertical: 'middle' };
    titleCell.fill = {
        type: 'pattern',
        pattern: 'solid',
        fgColor: { argb: 'FFFFFF00' }
    };
    titleCell.border = {
        top: { style: 'thin' },
        left: { style: 'thin' },
        bottom: { style: 'thin' },
        right: { style: 'thin' }
    };
    
    ['B1', 'C1'].forEach(cell => {
        const c = worksheet.getCell(cell);
        c.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FFFFFF00' }
        };
        c.border = {
            top: { style: 'thin' },
            left: { style: 'thin' },
            bottom: { style: 'thin' },
            right: { style: 'thin' }
        };
    });
    
    // ENCABEZADOS
    const headers = ['Nombre completo', 'CI', 'Fecha y hora de ingreso'];
    worksheet.getRow(2).values = headers;
    
    headers.forEach((header, index) => {
        const cell = worksheet.getCell(2, index + 1);
        cell.font = { bold: true };
        cell.alignment = { horizontal: 'center', vertical: 'middle' };
        cell.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FFFFFF00' }
        };
        cell.border = {
            top: { style: 'thin' },
            left: { style: 'thin' },
            bottom: { style: 'thin' },
            right: { style: 'thin' }
        };
    });
    
    // DATOS
    let row = 3;
    filteredPeople.forEach(p => {
        const date = new Date(p.entryTime);
        const ingreso = date.toLocaleString("es-ES", {
            day: "2-digit",
            month: "2-digit",
            year: "numeric",
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit"
        });
        
        worksheet.getRow(row).values = [p.name, p.ci, ingreso];
        
        [1, 2, 3].forEach(col => {
            const cell = worksheet.getCell(row, col);
            cell.border = {
                top: { style: 'thin' },
                left: { style: 'thin' },
                bottom: { style: 'thin' },
                right: { style: 'thin' }
            };
        });
        
        row++;
    });
    
    // RESUMEN
    const summaryRow = row + 1;
    worksheet.getRow(summaryRow).values = [
        `TOTAL PRESENTES: ${filteredPeople.length}`,
        '',
        ''
    ];
    
    [1, 2, 3].forEach(col => {
        const cell = worksheet.getCell(summaryRow, col);
        cell.font = { bold: true };
        cell.alignment = { horizontal: 'center', vertical: 'middle' };
        cell.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FFFFFF00' }
        };
        cell.border = {
            top: { style: 'thin' },
            left: { style: 'thin' },
            bottom: { style: 'thin' },
            right: { style: 'thin' }
        };
    });
    
    worksheet.getColumn(1).width = 35;
    worksheet.getColumn(2).width = 15;
    worksheet.getColumn(3).width = 25;
    
    const buffer = await workbook.xlsx.writeBuffer();
    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Asistencia_${selectedDate}.xlsx`;
    a.click();
    window.URL.revokeObjectURL(url);
}

// ============================
// Enviar reporte del d√≠a por WhatsApp
// ============================
function sendDateReportByWhatsApp() {
    const selectedDate = document.getElementById("reportDate").value;
    
    if (!selectedDate) {
        alert("Por favor seleccione una fecha");
        return;
    }
    
    const filteredPeople = filterPeopleByDate(selectedDate);
    
    if (filteredPeople.length === 0) {
        alert("No hay registros de asistencia para la fecha seleccionada");
        return;
    }
    
    const formattedDate = new Date(selectedDate).toLocaleDateString('es-ES');
    
    let message = `üìÑ *INFORME DE ASISTENCIA*\n`;
    message += `üìÖ *Fecha:* ${formattedDate}\n\n`;
    message += `‚úÖ *Total Presentes:* ${filteredPeople.length}\n\n`;
    
    const MAX = 15;
    const list = filteredPeople.slice(0, MAX);
    
    list.forEach(p => {
        const date = new Date(p.entryTime);
        const ingreso = date.toLocaleString("es-ES", {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        message += `üë§ *${p.name}*\n   CI: ${p.ci}\n   üïí ${ingreso}\n\n`;
    });
    
    if (filteredPeople.length > MAX) {
        message += `... y ${filteredPeople.length - MAX} m√°s.\n`;
    }
    
    message += `\nüìä Generado: ${new Date().toLocaleString("es-ES")}`;
    
    const encoded = encodeURIComponent(message);
    const whatsappUrl = `https://wa.me/?text=${encoded}`;
    window.open(whatsappUrl, '_blank');
}

// ============================
// Generar PDF del d√≠a
// ============================
async function generateDatePDF() {
    const selectedDate = document.getElementById("reportDate").value;
    
    if (!selectedDate) {
        alert("Por favor seleccione una fecha");
        return;
    }
    
    const filteredPeople = filterPeopleByDate(selectedDate);
    
    if (filteredPeople.length === 0) {
        alert("No hay registros de asistencia para la fecha seleccionada");
        return;
    }
    
    // Cargar jsPDF
    if (!window.jspdf) {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
        document.head.appendChild(script);
        await new Promise(resolve => script.onload = resolve);
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    const formattedDate = new Date(selectedDate).toLocaleDateString('es-ES');
    
    // T√≠tulo
    doc.setFontSize(16);
    doc.text('LISTA DE ASISTENCIA', 105, 20, { align: 'center' });
    
    doc.setFontSize(12);
    doc.text(`Fecha: ${formattedDate}`, 105, 30, { align: 'center' });
    
    // Tabla
    let y = 45;
    doc.setFontSize(10);
    
    // Encabezados
    doc.setFont(undefined, 'bold');
    doc.text('Nombre', 20, y);
    doc.text('CI', 120, y);
    doc.text('Hora de Ingreso', 160, y);
    
    y += 7;
    doc.line(20, y, 190, y);
    y += 5;
    
    // Datos
    doc.setFont(undefined, 'normal');
    filteredPeople.forEach((p, idx) => {
        if (y > 270) {
            doc.addPage();
            y = 20;
        }
        
        const date = new Date(p.entryTime);
        const ingreso = date.toLocaleTimeString("es-ES", {
            hour: "2-digit",
            minute: "2-digit"
        });
        
        const nombre = p.name.length > 35 ? p.name.substring(0, 32) + '...' : p.name;
        
        doc.text(nombre, 20, y);
        doc.text(p.ci, 120, y);
        doc.text(ingreso, 160, y);
        
        y += 7;
    });
    
    // Resumen
    y += 5;
    doc.line(20, y, 190, y);
    y += 7;
    doc.setFont(undefined, 'bold');
    doc.text(`Total Presentes: ${filteredPeople.length}`, 20, y);
    
    doc.save(`Asistencia_${selectedDate}.pdf`);
}

// ============================
// Registrar persona manualmente
// ============================
function addPerson() {
    const name = document.getElementById("inputName").value.trim();
    const ci = document.getElementById("inputCI").value.trim();
    const birthDate = document.getElementById("inputBirthDate").value;
    const phone = document.getElementById("inputPhone").value.trim();
    const email = document.getElementById("inputEmail").value.trim();

    if (!name || !ci || !birthDate) {
        alert("Por favor, complete Nombre, CI y Fecha de nacimiento.");
        return;
    }

    if (peopleBase.some(p => p.ci === ci)) {
        alert("Ya existe una persona con ese CI.");
        return;
    }

    const newPerson = {
        name,
        ci,
        birthDate,
        phone: phone || "-",
        email: email || "-",
        status: "not-arrived"
    };

    peopleBase.push(newPerson);
    saveToLocalStorage();
    renderFilteredPersons();
    updateStats();

    document.getElementById("inputName").value = "";
    document.getElementById("inputCI").value = "";
    document.getElementById("inputBirthDate").value = "";
    document.getElementById("inputPhone").value = "";
    document.getElementById("inputEmail").value = "";

    const controlTab = new bootstrap.Tab(document.querySelector('.nav-link[data-bs-target="#control"]'));
    controlTab.show();
}

// ============================
// Guardar en localStorage
// ============================
function saveToLocalStorage() {
    localStorage.setItem("attendanceBase", JSON.stringify(peopleBase));
}

// ============================
// Actualizar estad√≠sticas
// ============================
function updateStats() {
    const total = peopleBase.length;
    const present = peopleBase.filter(p => p.status === "present").length;
    const absent = peopleBase.filter(p => p.status === "absent").length;
    const notArrived = total - present - absent;

    document.getElementById("totalPersons").textContent = total;
    document.getElementById("totalPresent").textContent = present;
    document.getElementById("totalAbsent").textContent = absent;
    document.getElementById("totalNotArrived").textContent = notArrived;
}

// ============================
// Conversi√≥n segura de fecha de Excel
// ============================
function excelDateToJSDate(serial) {
    const epoch = Date.UTC(1899, 11, 30);
    if (serial < 60) {
        serial = serial + 1;
    }
    return new Date(epoch + (serial * 24 * 60 * 60 * 1000));
}

// ============================
// Importar desde Excel
// ============================
function importExcel(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array', cellDates: true });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];

            const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                header: 1,
                raw: false,
                dateNF: 'yyyy-mm-dd'
            });

            if (jsonData.length < 2) {
                alert("El archivo Excel est√° vac√≠o o no tiene datos.");
                return;
            }

            const headers = jsonData[0].map(h => h.toString().toLowerCase().trim());
            const ciIndex = headers.indexOf("ci");
            const nameIndex = headers.findIndex(h => /nombre|name/i.test(h));
            const birthIndex = headers.findIndex(h => /nacimiento|fecha|birth|date/i.test(h));
            const phoneIndex = headers.findIndex(h => /celular|phone|tel/i.test(h));
            const emailIndex = headers.findIndex(h => /correo|email/i.test(h));

            if (ciIndex === -1 || nameIndex === -1 || birthIndex === -1) {
                alert("El archivo debe contener: Nombre, CI y Fecha de nacimiento.");
                return;
            }

            let nuevos = 0;
            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                const ci = (row[ciIndex] || "").toString().trim();
                const name = (row[nameIndex] || "").toString().trim();
                let birthDate = row[birthIndex];

                if (birthDate instanceof Date) {
                    if (isNaN(birthDate.getTime())) {
                        continue;
                    }
                    birthDate = birthDate.toISOString().split('T')[0];
                } else if (typeof birthDate === 'number') {
                    const jsDate = excelDateToJSDate(birthDate);
                    if (isNaN(jsDate.getTime())) continue;
                    birthDate = jsDate.toISOString().split('T')[0];
                } else {
                    birthDate = (birthDate || "").toString().trim();
                    if (!birthDate) continue;
                }

                const phone = (row[phoneIndex] || "").toString().trim() || "-";
                const email = (row[emailIndex] || "").toString().trim() || "-";

                if (!ci || !name || !birthDate) continue;
                if (peopleBase.some(p => p.ci === ci)) continue;

                peopleBase.push({
                    name,
                    ci,
                    birthDate,
                    phone,
                    email,
                    status: "not-arrived"
                });
                nuevos++;
            }

            if (nuevos > 0) {
                saveToLocalStorage();
                renderFilteredPersons();
                updateStats();
                alert(`‚úÖ Se importaron ${nuevos} registros nuevos.`);
            } else {
                alert("‚ÑπÔ∏è No se encontraron registros nuevos.");
            }
        } catch (err) {
            console.error(err);
            alert("‚ùå Error al procesar el archivo Excel: " + err.message);
        }
    };
    reader.readAsArrayBuffer(file);
    event.target.value = "";
}

// ============================
// Exportar base como JSON
// ============================
function exportBaseJSON() {
    const dataStr = JSON.stringify(peopleBase, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "asistencia_base.json";
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }, 0);
}

// ============================
// Cargar base desde JSON
// ============================
function loadBaseJSON(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const loaded = JSON.parse(e.target.result);
            if (!Array.isArray(loaded)) throw new Error("Formato inv√°lido");

            const valid = loaded.every(p => p.name && p.ci && p.birthDate);
            if (!valid) throw new Error("Faltan campos obligatorios");

            peopleBase = loaded;
            saveToLocalStorage();
            renderFilteredPersons();
            updateStats();
            alert("‚úÖ Base cargada exitosamente.");
        } catch (err) {
            alert("‚ùå Error al cargar JSON: " + err.message);
        }
    };
    reader.readAsText(file);
    event.target.value = "";
}

// ============================
// Exportar informe de asistencia (Excel)
// ============================
async function exportAttendanceReport() {
    const total = peopleBase.length;
    const present = peopleBase.filter(p => p.status === "present").length;
    const notArrived = total - present;

    const ExcelJS = window.ExcelJS || await import('https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js');

    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet('Asistencia');

    worksheet.mergeCells('A1:C1');
    const titleCell = worksheet.getCell('A1');
    titleCell.value = 'LISTA DE ASISTENCIA';
    titleCell.font = { bold: true, size: 14 };
    titleCell.alignment = { horizontal: 'center', vertical: 'middle' };
    titleCell.fill = {
        type: 'pattern',
        pattern: 'solid',
        fgColor: { argb: 'FFFFFF00' }
    };
    titleCell.border = {
        top: { style: 'thin' },
        left: { style: 'thin' },
        bottom: { style: 'thin' },
        right: { style: 'thin' }
    };

    ['B1', 'C1'].forEach(cell => {
        const c = worksheet.getCell(cell);
        c.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FFFFFF00' }
        };
        c.border = {
            top: { style: 'thin' },
            left: { style: 'thin' },
            bottom: { style: 'thin' },
            right: { style: 'thin' }
        };
    });

    const headers = ['Nombre completo', 'CI', 'Fecha y hora de ingreso'];
    worksheet.getRow(2).values = headers;

    headers.forEach((header, index) => {
        const cell = worksheet.getCell(2, index + 1);
        cell.font = { bold: true };
        cell.alignment = { horizontal: 'center', vertical: 'middle' };
        cell.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FFFFFF00' }
        };
        cell.border = {
            top: { style: 'thin' },
            left: { style: 'thin' },
            bottom: { style: 'thin' },
            right: { style: 'thin' }
        };
    });

    let row = 3;
    peopleBase.forEach(p => {
        let ingreso = "No lleg√≥";
        if (p.status === "present" && p.entryTime) {
            const date = new Date(p.entryTime);
            ingreso = date.toLocaleString("es-ES", {
                day: "2-digit",
                month: "2-digit",
                year: "numeric",
                hour: "2-digit",
                minute: "2-digit",
                second: "2-digit"
            });
        }

        worksheet.getRow(row).values = [p.name, p.ci, ingreso];

        [1, 2, 3].forEach(col => {
            const cell = worksheet.getCell(row, col);
            cell.border = {
                top: { style: 'thin' },
                left: { style: 'thin' },
                bottom: { style: 'thin' },
                right: { style: 'thin' }
            };
        });

        row++;
    });

    const summaryRow = row + 1;
    worksheet.getRow(summaryRow).values = [
        `TOTAL: ${total}`,
        `‚úÖ Presentes: ${present}`,
        `‚è≥ No llegaron: ${notArrived}`
    ];

    [1, 2, 3].forEach(col => {
        const cell = worksheet.getCell(summaryRow, col);
        cell.font = { bold: true };
        cell.alignment = { horizontal: 'center', vertical: 'middle' };
        cell.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FFFFFF00' }
        };
        cell.border = {
            top: { style: 'thin' },
            left: { style: 'thin' },
            bottom: { style: 'thin' },
            right: { style: 'thin' }
        };
    });

    worksheet.getColumn(1).width = 35;
    worksheet.getColumn(2).width = 15;
    worksheet.getColumn(3).width = 25;

    const buffer = await workbook.xlsx.writeBuffer();
    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'LISTA_DE_ASISTENCIA.xlsx';
    a.click();
    window.URL.revokeObjectURL(url);
}

// ============================
// Enviar informe por WhatsApp
// ============================
function sendReportByWhatsApp() {
    if (peopleBase.length === 0) {
        alert("No hay datos para enviar.");
        return;
    }

    const total = peopleBase.length;
    const present = peopleBase.filter(p => p.status === "present").length;
    const absent = peopleBase.filter(p => p.status === "absent").length;
    const notArrived = total - present - absent;

    let message = `üìÑ *INFORME DE ASISTENCIA*\n\n`;
    message += `üìä *Total:* ${total} | ‚úÖ *Presentes:* ${present}\n`;

    const MAX = 15;
    const list = peopleBase.slice(0, MAX);

    list.forEach(p => {
        let ingreso = "No lleg√≥";
        if (p.status === "present" && p.entryTime) {
            const date = new Date(p.entryTime);
            ingreso = date.toLocaleString("es-ES", {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        message += `üë§ *${p.name}*\n   CI: ${p.ci}\n   üïí ${ingreso}\n\n`;
    });

    if (peopleBase.length > MAX) {
        message += `... y ${peopleBase.length - MAX} m√°s.\n`;
    }

    message += `\nüìÖ Generado: ${new Date().toLocaleString("es-ES")}`;

    const encoded = encodeURIComponent(message);
    const whatsappUrl = `https://wa.me/?text=${encoded}`;
    window.open(whatsappUrl, '_blank');
}
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>

</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Control de Ingresos - Rectorado</title>

<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">

<style>
:root{
  --bg:#020617;
  --card:#020617;
  --border:#1e293b;
  --text:#e5e7eb;
  --muted:#94a3b8;
}

body{
  background: radial-gradient(circle at top,#1e293b,#020617);
  min-height:100vh;
  color:var(--text);
  padding:20px;
}

.main-card{
  background:var(--card);
  border-radius:16px;
  border:1px solid var(--border);
  box-shadow:0 20px 40px rgba(0,0,0,.6);
}

.stat-card{
  border:1px solid var(--border);
  border-radius:12px;
  padding:20px;
  text-align:center;
}

.person-card{
  border:1px solid var(--border);
  border-radius:12px;
  padding:15px;
  margin-bottom:15px;
}

.filter-card{
  border:1px solid var(--border);
  border-radius:12px;
  padding:20px;
  margin-bottom:20px;
  background: rgba(30, 41, 59, 0.5);
}

.form-control,.form-select,.input-group-text{
  background:#020617;
  border:1px solid var(--border);
  color:var(--text);
}

.form-control::placeholder{color:var(--muted);}

.form-select option {
  background:#020617;
  color:var(--text);
}

.status-badge{
  padding:6px 14px;
  border-radius:999px;
  font-size:.8rem;
  font-weight:600;
  background:#064e3b;
  color:#6ee7b7;
}

.destination-badge{
  padding:4px 10px;
  border-radius:999px;
  font-size:.75rem;
  font-weight:600;
  background:#1e40af;
  color:#93c5fd;
  display: inline-block;
  margin-top: 5px;
}

.text-muted{color:rgb(117, 116, 116) !important;}

.btn-group-custom {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.time-info {
  font-size: 0.85rem;
  color: var(--muted);
  margin-top: 5px;
}

#newDestinationInput {
  display: none;
}
</style>
</head>

<body>
<div class="container">
<div class="main-card p-4">

<!-- HEADER -->
<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
<h4><i class="fas fa-building text-primary"></i> Control de Ingresos - Rectorado</h4>

<div class="d-flex gap-2 flex-wrap">
<label class="btn btn-secondary mb-0">
<i class="fas fa-folder-open"></i> Cargar Datos
<input type="file" accept=".json" hidden onchange="loadBaseJSON(event)">
</label>

<button class="btn btn-primary" onclick="exportBaseJSON()">
<i class="fas fa-file-code"></i> Exportar Datos
</button>

<button class="btn btn-info" onclick="exportAttendanceReport()">
<i class="fas fa-file-alt"></i> Reporte General
</button>

<button class="btn btn-success" onclick="sendReportByWhatsApp()">
  <i class="fab fa-whatsapp"></i> WhatsApp
</button>

</div>
</div>

<!-- STATS -->
<div class="row mb-4 text-center">
<div class="col-md-12"><div class="stat-card"><h5 id="totalPersons">0</h5><small>Total de Visitantes</small></div></div>
</div>

<!-- TABS -->
<ul class="nav nav-tabs mb-3">
<li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#control">Registro de Ingresos</button></li>
<li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#register">Nuevo Ingreso</button></li>
</ul>

<div class="tab-content">

<!-- CONTROL -->
<div class="tab-pane fade show active" id="control">

<!-- FILTRO DE FECHA PARA REPORTES -->
<div class="filter-card">
  <div class="row align-items-end">
    <div class="col-md-4">
      <label class="form-label"><i class="fas fa-calendar"></i> Filtrar por Fecha</label>
      <input type="date" id="reportDate" class="form-control" value="">
    </div>
    <div class="col-md-8">
      <div class="btn-group-custom">
        <button class="btn btn-info" onclick="generateDateReport()">
          <i class="fas fa-file-alt"></i> Reporte del D√≠a
        </button>
        <button class="btn btn-success" onclick="sendDateReportByWhatsApp()">
          <i class="fab fa-whatsapp"></i> WhatsApp del D√≠a
        </button>
        <button class="btn btn-warning" onclick="generateDatePDF()">
          <i class="fas fa-file-pdf"></i> PDF del D√≠a
        </button>
        <button class="btn btn-secondary" onclick="clearDateFilter()">
          <i class="fas fa-times"></i> Ver Todos
        </button>
      </div>
    </div>
  </div>
  <div id="dateFilterInfo" class="mt-2 text-info small"></div>
</div>

<!-- BUSCADOR -->
<div class="mb-3">
  <input id="searchInput" class="form-control" placeholder="Buscar por nombre o destino" 
         oninput="filterPeople(this.value)">
</div>

<div id="personsList"></div>
</div>

<!-- REGISTER -->
<div class="tab-pane fade" id="register">
<div class="row justify-content-center">
<div class="col-md-6">
<div class="card bg-dark text-light">
<div class="card-body">
<h5 class="mb-3"><i class="fas fa-user-check"></i> Registrar Nuevo Ingreso</h5>
<div class="alert alert-info">
  <i class="fas fa-info-circle"></i> Al registrar, se guarda autom√°ticamente la fecha y hora de ingreso.
</div>
<div class="mb-3">
  <label class="form-label"><i class="fas fa-user"></i> Nombre del Visitante</label>
  <input class="form-control" id="inputName" placeholder="Ej: Juan P√©rez Gonz√°lez">
</div>
<div class="mb-3">
  <label class="form-label"><i class="fas fa-map-marker-alt"></i> Oficina / Unidad / Destino</label>
  <select class="form-select" id="selectDestination" onchange="handleDestinationChange()">
    <option value="">-- Seleccionar destino --</option>
  </select>
</div>
<div class="mb-3" id="newDestinationInput">
  <label class="form-label">Nuevo Destino</label>
  <input class="form-control" id="inputNewDestination" placeholder="Ej: Direcci√≥n Acad√©mica, Decanato, Secretar√≠a General">
</div>
<button class="btn btn-primary w-100 btn-lg" onclick="addPerson()">
  <i class="fas fa-sign-in-alt"></i> Registrar Ingreso
</button>
</div>
</div>
</div>
</div>
</div>

</div>
</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>

// ============================
// Estado inicial de la base
// ============================
let peopleBase = JSON.parse(localStorage.getItem("attendanceBase")) || [];

// ============================
// Al cargar la p√°gina
// ============================
document.addEventListener("DOMContentLoaded", () => {
    // Establecer fecha de hoy por defecto
    const today = new Date().toISOString().split('T')[0];
    document.getElementById("reportDate").value = today;
    
    loadDestinations();
    renderPersons(peopleBase);
    updateStats();
    updateDateFilterInfo();
});

// ============================
// Cargar destinos en el select
// ============================
function loadDestinations() {
    const select = document.getElementById("selectDestination");
    
    // Obtener destinos √∫nicos de todos los registros
    const destinations = [...new Set(peopleBase.map(p => p.destination).filter(d => d))];
    
    // Limpiar opciones excepto la primera
    select.innerHTML = '<option value="">-- Seleccionar destino --</option>';
    
    // Agregar destinos existentes ordenados alfab√©ticamente
    destinations.sort().forEach(dest => {
        const option = document.createElement("option");
        option.value = dest;
        option.textContent = dest;
        select.appendChild(option);
    });
    
    // Agregar opci√≥n "Otro (nuevo)"
    const optionOther = document.createElement("option");
    optionOther.value = "NUEVO";
    optionOther.textContent = "‚ûï Otro (nuevo destino)";
    select.appendChild(optionOther);
}

// ============================
// Manejar cambio en select de destino
// ============================
function handleDestinationChange() {
    const select = document.getElementById("selectDestination");
    const newDestinationDiv = document.getElementById("newDestinationInput");
    const newDestinationInput = document.getElementById("inputNewDestination");
    
    if (select.value === "NUEVO") {
        newDestinationDiv.style.display = "block";
        newDestinationInput.value = "";
        newDestinationInput.focus();
    } else {
        newDestinationDiv.style.display = "none";
        newDestinationInput.value = "";
    }
}

// ============================
// Actualizar info del filtro de fecha
// ============================
function updateDateFilterInfo() {
    const selectedDate = document.getElementById("reportDate").value;
    if (!selectedDate) return;
    
    const filtered = filterPeopleByDate(selectedDate);
    const infoDiv = document.getElementById("dateFilterInfo");
    
    if (filtered.length > 0) {
        const formattedDate = new Date(selectedDate + 'T00:00:00').toLocaleDateString('es-ES');
        infoDiv.innerHTML = `<i class="fas fa-info-circle"></i> Mostrando ${filtered.length} ingreso(s) del ${formattedDate}`;
    } else {
        const formattedDate = new Date(selectedDate + 'T00:00:00').toLocaleDateString('es-ES');
        infoDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> No hay ingresos registrados para el ${formattedDate}`;
    }
}

// ============================
// Renderizar lista de personas
// ============================
function renderPersons(list) {
    const container = document.getElementById("personsList");
    container.innerHTML = "";

    if (list.length === 0) {
        container.innerHTML = `<p class="text-muted">No hay ingresos registrados.</p>`;
        return;
    }

    list.forEach((person, index) => {
        // Formatear entrada (siempre existe)
        const entryInfo = `<div class="time-info"><i class="fas fa-clock text-success"></i> Ingreso: ${formatDateTime(person.entryTime)}</div>`;
        
        // Mostrar destino
        const destinationBadge = person.destination ? 
            `<span class="destination-badge"><i class="fas fa-building"></i> ${person.destination}</span>` : '';

        const card = document.createElement("div");
        card.className = "person-card";
        card.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <strong>${index + 1}. ${person.name}</strong>
                    ${destinationBadge}
                    ${entryInfo}
                </div>
                <div class="text-end">
                    <span class="status-badge"><i class="fas fa-check-circle"></i> Registrado</span><br>
                    <button class="btn btn-sm btn-danger mt-2" onclick="deletePerson(${index})">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                </div>
            </div>
        `;
        container.appendChild(card);
    });
}

// Funci√≥n auxiliar para mostrar fechas y horas legibles
function formatDateTime(isoString) {
    if (!isoString) return "-";
    const date = new Date(isoString);
    if (isNaN(date.getTime())) return isoString;
    return date.toLocaleString("es-ES", {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
}

// ============================
// Eliminar persona
// ============================
function deletePerson(index) {
    if (confirm(`¬øEst√° seguro de eliminar el registro de ${peopleBase[index].name}?`)) {
        peopleBase.splice(index, 1);
        saveToLocalStorage();
        loadDestinations(); // Actualizar lista de destinos
        renderFilteredPersons();
        updateStats();
        updateDateFilterInfo();
    }
}

// ============================
// Filtrar personas (b√∫squeda)
// ============================
function filterPeople(query) {
    const lowerQuery = query.toLowerCase().trim();
    const filtered = peopleBase.filter(p => 
        p.name.toLowerCase().includes(lowerQuery) ||
        (p.destination && p.destination.toLowerCase().includes(lowerQuery))
    );
    renderPersons(filtered);
}

// ============================
// Renderizar sin filtro (despu√©s de cambios)
// ============================
function renderFilteredPersons() {
    const query = document.getElementById("searchInput").value;
    if (query) {
        filterPeople(query);
    } else {
        renderPersons(peopleBase);
    }
}

// ============================
// Filtrar personas por fecha
// ============================
function filterPeopleByDate(targetDate) {
    if (!targetDate) return peopleBase;
    
    // Crear fecha objetivo en zona horaria local
    const targetParts = targetDate.split('-');
    const targetYear = parseInt(targetParts[0]);
    const targetMonth = parseInt(targetParts[1]) - 1; // Mes en JS es 0-indexed
    const targetDay = parseInt(targetParts[2]);
    
    return peopleBase.filter(p => {
        if (p.entryTime) {
            const entryDate = new Date(p.entryTime);
            const entryYear = entryDate.getFullYear();
            const entryMonth = entryDate.getMonth();
            const entryDay = entryDate.getDate();
            
            return entryYear === targetYear && 
                   entryMonth === targetMonth && 
                   entryDay === targetDay;
        }
        return false;
    });
}

// ============================
// Limpiar filtro de fecha
// ============================
function clearDateFilter() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById("reportDate").value = today;
    document.getElementById("searchInput").value = "";
    renderPersons(peopleBase);
    updateDateFilterInfo();
}

// ============================
// Registrar persona (CON ENTRADA AUTOM√ÅTICA)
// ============================
function addPerson() {
    const name = document.getElementById("inputName").value.trim();
    const selectDestination = document.getElementById("selectDestination");
    const newDestinationInput = document.getElementById("inputNewDestination");
    
    let destination = "";
    
    if (!name) {
        alert("Por favor, ingrese el nombre del visitante.");
        return;
    }

    // Determinar el destino
    if (selectDestination.value === "NUEVO") {
        destination = newDestinationInput.value.trim();
        if (!destination) {
            alert("Por favor, ingrese el destino.");
            return;
        }
    } else {
        destination = selectDestination.value.trim();
        if (!destination) {
            alert("Por favor, seleccione un destino.");
            return;
        }
    }

    const now = new Date().toISOString();

    const newPerson = {
        name,
        destination,
        entryTime: now // Entrada autom√°tica al registrar
    };

    peopleBase.push(newPerson);
    saveToLocalStorage();
    loadDestinations(); // Actualizar lista de destinos
    renderFilteredPersons();
    updateStats();
    updateDateFilterInfo();

    // Limpiar
    document.getElementById("inputName").value = "";
    selectDestination.value = "";
    newDestinationInput.value = "";
    document.getElementById("newDestinationInput").style.display = "none";

    // Cambiar pesta√±a
    const controlTab = new bootstrap.Tab(document.querySelector('.nav-link[data-bs-target="#control"]'));
    controlTab.show();
    
    alert(`‚úÖ Ingreso registrado exitosamente\n\nVisitante: ${name}\nDestino: ${destination}\nHora: ${formatDateTime(now)}`);
}

// ============================
// Guardar en localStorage
// ============================
function saveToLocalStorage() {
    localStorage.setItem("attendanceBase", JSON.stringify(peopleBase));
}

// ============================
// Actualizar estad√≠sticas
// ============================
function updateStats() {
    const total = peopleBase.length;
    document.getElementById("totalPersons").textContent = total;
}

// ============================
// Generar informe del d√≠a (Excel)
// ============================
async function generateDateReport() {
    const selectedDate = document.getElementById("reportDate").value;
    
    if (!selectedDate) {
        alert("Por favor seleccione una fecha");
        return;
    }
    
    const filteredPeople = filterPeopleByDate(selectedDate);
    
    if (filteredPeople.length === 0) {
        alert("No hay ingresos registrados para la fecha seleccionada");
        return;
    }
    
    const ExcelJS = window.ExcelJS || await import('https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js');
    
    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet('Ingresos');
    
    const formattedDate = new Date(selectedDate + 'T00:00:00').toLocaleDateString('es-ES');
    
    // T√çTULO
    worksheet.mergeCells('A1:D1');
    const titleCell = worksheet.getCell('A1');
    titleCell.value = `REGISTRO DE INGRESOS AL RECTORADO - ${formattedDate}`;
    titleCell.font = { bold: true, size: 14 };
    titleCell.alignment = { horizontal: 'center', vertical: 'middle' };
    titleCell.fill = {
        type: 'pattern',
        pattern: 'solid',
        fgColor: { argb: 'FFFFFF00' }
    };
    titleCell.border = {
        top: { style: 'thin' },
        left: { style: 'thin' },
        bottom: { style: 'thin' },
        right: { style: 'thin' }
    };
    
    ['B1', 'C1', 'D1'].forEach(cell => {
        const c = worksheet.getCell(cell);
        c.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FFFFFF00' }
        };
        c.border = {
            top: { style: 'thin' },
            left: { style: 'thin' },
            bottom: { style: 'thin' },
            right: { style: 'thin' }
        };
    });
    
    // ENCABEZADOS
    const headers = ['#', 'Nombre del Visitante', 'Oficina/Unidad', 'Hora de Ingreso'];
    worksheet.getRow(2).values = headers;
    
    headers.forEach((header, index) => {
        const cell = worksheet.getCell(2, index + 1);
        cell.font = { bold: true };
        cell.alignment = { horizontal: 'center', vertical: 'middle' };
        cell.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FFFFFF00' }
        };
        cell.border = {
            top: { style: 'thin' },
            left: { style: 'thin' },
            bottom: { style: 'thin' },
            right: { style: 'thin' }
        };
    });
    
    // DATOS
    let row = 3;
    filteredPeople.forEach((p, idx) => {
        const entryTime = p.entryTime ? new Date(p.entryTime).toLocaleString("es-ES", {
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit"
        }) : "-";
        
        worksheet.getRow(row).values = [idx + 1, p.name, p.destination || "-", entryTime];
        
        [1, 2, 3, 4].forEach(col => {
            const cell = worksheet.getCell(row, col);
            cell.border = {
                top: { style: 'thin' },
                left: { style: 'thin' },
                bottom: { style: 'thin' },
                right: { style: 'thin' }
            };
        });
        
        row++;
    });
    
    // RESUMEN
    const summaryRow = row + 1;
    worksheet.getRow(summaryRow).values = [
        '',
        `TOTAL VISITANTES: ${filteredPeople.length}`,
        '',
        ''
    ];
    
    [1, 2, 3, 4].forEach(col => {
        const cell = worksheet.getCell(summaryRow, col);
        cell.font = { bold: true };
        cell.alignment = { horizontal: 'center', vertical: 'middle' };
        cell.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FFFFFF00' }
        };
        cell.border = {
            top: { style: 'thin' },
            left: { style: 'thin' },
            bottom: { style: 'thin' },
            right: { style: 'thin' }
        };
    });
    
    worksheet.getColumn(1).width = 8;
    worksheet.getColumn(2).width = 35;
    worksheet.getColumn(3).width = 30;
    worksheet.getColumn(4).width = 20;
    
    const buffer = await workbook.xlsx.writeBuffer();
    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Ingresos_Rectorado_${selectedDate}.xlsx`;
    a.click();
    window.URL.revokeObjectURL(url);
}

// ============================
// Enviar reporte del d√≠a por WhatsApp
// ============================
function sendDateReportByWhatsApp() {
    const selectedDate = document.getElementById("reportDate").value;
    
    if (!selectedDate) {
        alert("Por favor seleccione una fecha");
        return;
    }
    
    const filteredPeople = filterPeopleByDate(selectedDate);
    
    if (filteredPeople.length === 0) {
        alert("No hay ingresos registrados para la fecha seleccionada");
        return;
    }
    
    const formattedDate = new Date(selectedDate + 'T00:00:00').toLocaleDateString('es-ES');
    
    let message = `üèõÔ∏è *REGISTRO DE INGRESOS AL RECTORADO*\n`;
    message += `üìÖ *Fecha:* ${formattedDate}\n\n`;
    message += `üë• *Total de visitantes:* ${filteredPeople.length}\n\n`;
    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
    
    filteredPeople.forEach((p, idx) => {
        const entryTime = p.entryTime ? new Date(p.entryTime).toLocaleTimeString("es-ES", {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        }) : "-";
        
        message += `${idx + 1}. *${p.name}*\n`;
        message += `   üè¢ Destino: ${p.destination || "-"}\n`;
        message += `   üïê Ingreso: ${entryTime}\n\n`;
    });
    
    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
    message += `üìä Generado: ${new Date().toLocaleString("es-ES")}`;
    
    const encoded = encodeURIComponent(message);
    const whatsappUrl = `https://wa.me/?text=${encoded}`;
    window.open(whatsappUrl, '_blank');
}

// ============================
// Generar PDF del d√≠a
// ============================
async function generateDatePDF() {
    const selectedDate = document.getElementById("reportDate").value;
    
    if (!selectedDate) {
        alert("Por favor seleccione una fecha");
        return;
    }
    
    const filteredPeople = filterPeopleByDate(selectedDate);
    
    if (filteredPeople.length === 0) {
        alert("No hay ingresos registrados para la fecha seleccionada");
        return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    const formattedDate = new Date(selectedDate + 'T00:00:00').toLocaleDateString('es-ES');
    
    // T√≠tulo
    doc.setFontSize(16);
    doc.text('REGISTRO DE INGRESOS AL RECTORADO', 105, 20, { align: 'center' });
    
    doc.setFontSize(12);
    doc.text(`Fecha: ${formattedDate}`, 105, 28, { align: 'center' });
    
    // Resumen
    doc.setFontSize(10);
    doc.text(`Total de visitantes: ${filteredPeople.length}`, 105, 36, { align: 'center' });
    
    // L√≠nea separadora
    doc.line(20, 40, 190, 40);
    
    // Tabla
    let y = 50;
    doc.setFontSize(9);
    
    // Encabezados
    doc.setFont(undefined, 'bold');
    doc.text('#', 20, y);
    doc.text('Nombre', 30, y);
    doc.text('Oficina/Unidad', 100, y);
    doc.text('Hora', 165, y);
    
    y += 5;
    doc.line(20, y, 190, y);
    y += 5;
    
    // Datos
    doc.setFont(undefined, 'normal');
    filteredPeople.forEach((p, idx) => {
        if (y > 270) {
            doc.addPage();
            y = 20;
        }
        
        const entryTime = p.entryTime ? new Date(p.entryTime).toLocaleTimeString("es-ES", {
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit"
        }) : "-";
        
        const nombre = p.name.length > 30 ? p.name.substring(0, 27) + '...' : p.name;
        const destino = p.destination && p.destination.length > 25 ? p.destination.substring(0, 22) + '...' : (p.destination || "-");
        
        doc.text(`${idx + 1}`, 20, y);
        doc.text(nombre, 30, y);
        doc.text(destino, 100, y);
        doc.text(entryTime, 165, y);
        
        y += 6;
    });
    
    // L√≠nea final
    y += 2;
    doc.line(20, y, 190, y);
    
    // Pie de p√°gina
    y += 8;
    doc.setFont(undefined, 'bold');
    doc.setFontSize(10);
    doc.text(`Total de visitantes: ${filteredPeople.length}`, 20, y);
    
    doc.save(`Ingresos_Rectorado_${selectedDate}.pdf`);
}

// ============================
// Exportar base como JSON
// ============================
function exportBaseJSON() {
    const dataStr = JSON.stringify(peopleBase, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "registro_ingresos_rectorado.json";
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }, 0);
}

// ============================
// Cargar base desde JSON
// ============================
function loadBaseJSON(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const loaded = JSON.parse(e.target.result);
            if (!Array.isArray(loaded)) throw new Error("Formato inv√°lido");

            const valid = loaded.every(p => p.name && p.entryTime);
            if (!valid) throw new Error("Faltan campos obligatorios");

            peopleBase = loaded;
            saveToLocalStorage();
            loadDestinations();
            renderFilteredPersons();
            updateStats();
            updateDateFilterInfo();
            alert("‚úÖ Datos cargados exitosamente.");
        } catch (err) {
            alert("‚ùå Error al cargar datos: " + err.message);
        }
    };
    reader.readAsText(file);
    event.target.value = "";
}

// ============================
// Exportar informe general (Excel)
// ============================
async function exportAttendanceReport() {
    if (peopleBase.length === 0) {
        alert("No hay registros para exportar");
        return;
    }

    const ExcelJS = window.ExcelJS || await import('https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js');

    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet('Ingresos');

    worksheet.mergeCells('A1:D1');
    const titleCell = worksheet.getCell('A1');
    titleCell.value = 'REGISTRO GENERAL DE INGRESOS AL RECTORADO';
    titleCell.font = { bold: true, size: 14 };
    titleCell.alignment = { horizontal: 'center', vertical: 'middle' };
    titleCell.fill = {
        type: 'pattern',
        pattern: 'solid',
        fgColor: { argb: 'FFFFFF00' }
    };
    titleCell.border = {
        top: { style: 'thin' },
        left: { style: 'thin' },
        bottom: { style: 'thin' },
        right: { style: 'thin' }
    };

    ['B1', 'C1', 'D1'].forEach(cell => {
        const c = worksheet.getCell(cell);
        c.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FFFFFF00' }
        };
        c.border = {
            top: { style: 'thin' },
            left: { style: 'thin' },
            bottom: { style: 'thin' },
            right: { style: 'thin' }
        };
    });

    const headers = ['#', 'Nombre del Visitante', 'Oficina/Unidad', 'Fecha y Hora de Ingreso'];
    worksheet.getRow(2).values = headers;

    headers.forEach((header, index) => {
        const cell = worksheet.getCell(2, index + 1);
        cell.font = { bold: true };
        cell.alignment = { horizontal: 'center', vertical: 'middle' };
        cell.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FFFFFF00' }
        };
        cell.border = {
            top: { style: 'thin' },
            left: { style: 'thin' },
            bottom: { style: 'thin' },
            right: { style: 'thin' }
        };
    });

    let row = 3;
    peopleBase.forEach((p, idx) => {
        const entryTime = formatDateTime(p.entryTime);

        worksheet.getRow(row).values = [idx + 1, p.name, p.destination || "-", entryTime];

        [1, 2, 3, 4].forEach(col => {
            const cell = worksheet.getCell(row, col);
            cell.border = {
                top: { style: 'thin' },
                left: { style: 'thin' },
                bottom: { style: 'thin' },
                right: { style: 'thin' }
            };
        });

        row++;
    });

    const summaryRow = row + 1;
    worksheet.getRow(summaryRow).values = [
        '',
        `TOTAL VISITANTES: ${peopleBase.length}`,
        '',
        ''
    ];

    [1, 2, 3, 4].forEach(col => {
        const cell = worksheet.getCell(summaryRow, col);
        cell.font = { bold: true };
        cell.alignment = { horizontal: 'center', vertical: 'middle' };
        cell.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FFFFFF00' }
        };
        cell.border = {
            top: { style: 'thin' },
            left: { style: 'thin' },
            bottom: { style: 'thin' },
            right: { style: 'thin' }
        };
    });

    worksheet.getColumn(1).width = 8;
    worksheet.getColumn(2).width = 35;
    worksheet.getColumn(3).width = 30;
    worksheet.getColumn(4).width = 25;

    const buffer = await workbook.xlsx.writeBuffer();
    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'REGISTRO_INGRESOS_RECTORADO.xlsx';
    a.click();
    window.URL.revokeObjectURL(url);
}

// ============================
// Enviar informe general por WhatsApp
// ============================
function sendReportByWhatsApp() {
    if (peopleBase.length === 0) {
        alert("No hay datos para enviar.");
        return;
    }

    let message = `üèõÔ∏è *REGISTRO DE INGRESOS AL RECTORADO*\n\n`;
    message += `üë• *Total de visitantes:* ${peopleBase.length}\n\n`;
    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;

    const MAX = 20;
    const list = peopleBase.slice(0, MAX);

    list.forEach((p, idx) => {
        const entryTime = p.entryTime ? new Date(p.entryTime).toLocaleString("es-ES", {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        }) : "-";

        message += `${idx + 1}. *${p.name}*\n`;
        message += `   üè¢ Destino: ${p.destination || "-"}\n`;
        message += `   üïê ${entryTime}\n\n`;
    });

    if (peopleBase.length > MAX) {
        message += `... y ${peopleBase.length - MAX} m√°s.\n\n`;
    }

    message += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
    message += `üìÖ Generado: ${new Date().toLocaleString("es-ES")}`;

    const encoded = encodeURIComponent(message);
    const whatsappUrl = `https://wa.me/?text=${encoded}`;
    window.open(whatsappUrl, '_blank');
}
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>

</body>
</html>
